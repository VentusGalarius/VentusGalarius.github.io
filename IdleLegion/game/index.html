<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Idle Legion</title>

    <meta name="viewport" 
          content="width=device-width,user-scalable=no,initial-scale=1, minimum-scale=1,maximum-scale=1"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="renderer" content="webkit"/>
    <meta name="force-rendering" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="full-screen" content="yes"/>
    <meta name="x5-fullscreen" content="true"/>
    <meta name="360-fullscreen" content="true"/>
    <meta name="screen-orientation" content="portrait"/>
    <meta name="x5-orientation" content="portrait">
    <meta name="x5-page-mode" content="app">

    <link rel="stylesheet" type="text/css" href="https://tgbz.res.game-dbl.com/style-mobile.5dcaa.css"/>
    <link rel="icon" href="https://tgbz.res.game-dbl.com/favicon.8de18.ico"/>
    <script type="application/javascript">
    !function(t,r,e,a,n,o,i,l,c,s,d,h,u){var f=i+"_q",m=i+"_c";t[i]=t[i]||{},t[f]=t[f]||[],t[m]=t[m]||[];for(let r=0;r<l.length;r++)d(t[i],t[f],l[r]);for(let r=0;r<c.length;r++){var g,b=c[r][0],p=c[r][1];t[i][b]=function(...r){return g=this,t[m].push((function(){g[s]=new t[i][b](...r)})),g};for(let r=0;r<p.length;r++){const e=p[r];t[i][b].prototype[e]=function(...r){t[m].push((function(){g[s][e](...r)}))}}}h=r.createElement(e),u=r.getElementsByTagName(e)[0],h.async=!0,h.src="https://cdn.adjust.com/adjust-latest.min.js",h.onload=function(){for(var r=0;r<t[m].length;r++)t[m][r]();t[m]=[];for(r=0;r<t[f].length;r++)t[f][r][1][0][s]?t[i][t[f][r][0]](t[f][r][1][0][s]):t[i][t[f][r][0]].apply(t[i],t[f][r][1]);t[f]=[]},u.parentNode.insertBefore(h,u)}(window,document,"script",0,0,0,"Adjust",["initSdk","getAttribution","getWebUUID","waitForAttribution","waitForWebUUID","setReferrer","trackEvent","addGlobalCallbackParameters","addGlobalPartnerParameters","removeGlobalCallbackParameter","removeGlobalPartnerParameter","clearGlobalCallbackParameters","clearGlobalPartnerParameters","switchToOfflineMode","switchBackToOnlineMode","stop","restart","gdprForgetMe","disableThirdPartySharing","trackThirdPartySharing","initSmartBanner","showSmartBanner","hideSmartBanner"],[["ThirdPartySharing",["addGranularOption","addPartnerSharingSetting"]]],"__realObj",(function(t,r,e){t[e]=function(){r.push([e,arguments])}}));
    </script>
</head>
<body>
<canvas id="GameCanvas" oncontextmenu="event.preventDefault()" tabindex="0"></canvas>
<div id="splash">
    <div class="progress-bar stripes">
        <span style="width: 0%"></span>
    </div>
</div>

<script src="https://tgbz.res.game-dbl.com/src/settings.b5804.js" charset="utf-8"></script>
<script src="https://tgbz.res.game-dbl.com/main.67d55.js" charset="utf-8"></script>
<script src="https://a-ttgme.stel.com/js/telegram-web-app.js"></script>
<script src="https://a-ttgme.stel.com/js/telegram-web-app-beta.js"></script>
<script src="https://a-ttgme.stel.com/js/tonconnect-ui.min.js"></script>
<script src="https://tgbz.res.game-dbl.com/thinkingdata.umd.min.5337f.js"></script>

<script type="text/javascript">
    class TelegramAPI {
        static init() {
            if (!window.Telegram?.WebApp) throw new Error("Telegram WebApp not detected");
            
            this.webApp = window.Telegram.WebApp;
            this.webApp.ready();
            this.webApp.expand();
            this.webApp.enableClosingConfirmation();
            
            if (this.webApp.platform !== 'web' && this.webApp.platform !== 'tdesktop') {
                this.webApp.requestFullscreen();
            }
        }

        static getUserData() {
            return {
                id: this.webApp.initDataUnsafe.user?.id,
                username: this.webApp.initDataUnsafe.user?.username,
                firstName: this.webApp.initDataUnsafe.user?.first_name,
                lastName: this.webApp.initDataUnsafe.user?.last_name,
                language: this.webApp.initDataUnsafe.user?.language_code
            };
        }

        static async getXTRBalance() {
            return new Promise((resolve, reject) => {
                this.webApp.sendData(JSON.stringify({
                    method: 'getBalance',
                    currency: 'XTR'
                }));
                
                this.webApp.onEvent('balanceReceived', (data) => {
                    data.currency === 'XTR' ? resolve(data.amount) : reject('Invalid currency');
                });
            });
        }

        static async processPayment(amount) {
            return this.webApp.openInvoice({
                currency: 'XTR',
                prices: [{ label: 'In-game purchase', amount: amount * 100 }]
            }, (status) => {
                if (status === 'failed') throw new Error('Payment failed');
            });
        }
    }

    class DebugConsole {
        constructor() {
            this.requests = [];
            this.createUI();
            this.hijackNetworkRequests();
        }

        createUI() {
            this.icon = document.createElement('div');
            this.icon.innerHTML = '🐞';
            this.icon.style = `position:fixed;bottom:20px;right:20px;z-index:9999;cursor:pointer`;
            this.icon.onclick = () => this.toggleConsole();
            document.body.appendChild(this.icon);

            this.consolePanel = document.createElement('div');
            this.consolePanel.style = `display:none;position:fixed;bottom:60px;right:20px;width:300px;height:400px;background:#1e1e1e;color:#fff;padding:10px;overflow:auto`;
            document.body.appendChild(this.consolePanel);
        }

        toggleConsole() {
            this.consolePanel.style.display = this.consolePanel.style.display === 'none' ? 'block' : 'none';
        }

        hijackNetworkRequests() {
            const originalFetch = window.fetch;
            window.fetch = async (...args) => {
                const request = { url: args[0], method: args[1]?.method || 'GET', payload: args[1]?.body };
                this.requests.push(request);
                this.log(`Request: ${JSON.stringify(request)}`);
                
                const response = await originalFetch(...args);
                const clonedResponse = response.clone();
                
                clonedResponse.json().then(data => {
                    this.log(`Response: ${JSON.stringify(data)}`);
                }).catch(() => null);
                
                return response;
            };
        }

        log(message) {
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toISOString()}] ${message}`;
            this.consolePanel.appendChild(entry);
        }
    }

    class PaymentHandler {
        static validateCurrency(amount) {
            if (typeof amount !== 'number' || amount <= 0) {
                throw new Error('Invalid XTR amount');
            }
            return amount.toFixed(2);
        }

        static async handlePurchase(amount) {
            try {
                const validatedAmount = this.validateCurrency(amount);
                await TelegramAPI.processPayment(validatedAmount);
                window.boot(); // Reload game state
            } catch (error) {
                new DebugConsole().log(`Payment Error: ${error.message}`);
            }
        }
    }

    (async function () {
        if (!window.Telegram?.WebApp) {
            alert('This app works only within Telegram');
            return;
        }

        window.loadingStartTime = Date.now();
        TelegramAPI.init();
        new DebugConsole();

        // ThinkingData initialization
        const taConfig = {
            appId: 'e5882a2b9c4543b69c2983178b1eebe2',
            serverUrl: 'https://rtsyx.higgsyx.com',
            send_method: 'ajax',
            autoTrack: { appShow: true, appHide: true, pageShow: true, pageHide: true },
            batch: { size: 50, interval: 30000, maxLimit: 500 }
        };
        
        window.ta = thinkingdata.init(taConfig);
        window.ta.login(TelegramAPI.getUserData().id);
        window.ta.setSuperProperties({ tgproject: "bz", platform: TelegramAPI.webApp.platform });

        // Load game scripts
        const loadScript = (src, cb) => {
            const script = document.createElement('script');
            script.onload = cb;
            script.src = src;
            document.body.appendChild(script);
        };

        loadScript(_CCSettings.debug ? 'cocos2d-js.js' : 'cocos2d-js-min.0f61a.js', () => {
            loadScript("src/assets/loaderplugin.js", () => {
                (CC_PHYSICS_BUILTIN || CC_PHYSICS_CANNON) 
                    ? loadScript(_CCSettings.debug ? 'physics.js' : 'physics-min.js', window.boot)
                    : window.boot();
            });
        });
    })();
</script>
</body>
</html>
