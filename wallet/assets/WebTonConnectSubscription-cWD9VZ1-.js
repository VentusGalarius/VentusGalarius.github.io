import{hL as ge,hM as we,hN as be,g as pe,co as J,d as C,hO as Te,gr as Ce,r as N,hP as ve,j as r,N as Se,G as Ae,b as X,hQ as je,hR as Ee,cy as Fe,fF as re,hS as G,hT as Ie,aS as Q,di as ie,dq as De,L as ce,dh as Re,hU as me,s as E,i as ke,cQ as Be,u as te,cs as ye,hV as Ne,hW as Me,v as se,H as _e,hX as Oe,fw as Ue,hY as We,hZ as Le,h_ as $e,h$ as He,i0 as Pe,i1 as Ve,i2 as ze,an as Ke,i3 as Je,i4 as Ge,i5 as Qe,am as Xe,i6 as Ye,i7 as Ze,i8 as qe,i9 as en}from"./index-pFCF53l2.js";const nn=async({connection:e,request:{id:n,method:l}})=>{await ge({response:be(n,l),sessionKeyPair:e.sessionKeyPair,clientSessionId:e.clientSessionId})},ae=async({connection:e,request:{id:n}})=>{await ge({response:we(n),sessionKeyPair:e.sessionKeyPair,clientSessionId:e.clientSessionId})};var q={};/*! crc32.js (C) 2014-present SheetJS -- http://sheetjs.com */var le;function tn(){return le||(le=1,function(e){(function(n){n(typeof DO_NOT_EXPORT_CRC>"u"?e:{})})(function(n){n.version="1.2.2";function l(){for(var s=0,T=new Array(256),o=0;o!=256;++o)s=o,s=s&1?-306674912^s>>>1:s>>>1,s=s&1?-306674912^s>>>1:s>>>1,s=s&1?-306674912^s>>>1:s>>>1,s=s&1?-306674912^s>>>1:s>>>1,s=s&1?-306674912^s>>>1:s>>>1,s=s&1?-306674912^s>>>1:s>>>1,s=s&1?-306674912^s>>>1:s>>>1,s=s&1?-306674912^s>>>1:s>>>1,T[o]=s;return typeof Int32Array<"u"?new Int32Array(T):T}var c=l();function a(s){var T=0,o=0,h=0,x=typeof Int32Array<"u"?new Int32Array(4096):new Array(4096);for(h=0;h!=256;++h)x[h]=s[h];for(h=0;h!=256;++h)for(o=s[h],T=256+h;T<4096;T+=256)o=x[T]=o>>>8^s[o&255];var t=[];for(h=1;h!=16;++h)t[h-1]=typeof Int32Array<"u"?x.subarray(h*256,h*256+256):x.slice(h*256,h*256+256);return t}var i=a(c),f=i[0],w=i[1],F=i[2],R=i[3],y=i[4],I=i[5],b=i[6],D=i[7],u=i[8],v=i[9],S=i[10],$=i[11],L=i[12],P=i[13],Y=i[14];function Z(s,T){for(var o=T^-1,h=0,x=s.length;h<x;)o=o>>>8^c[(o^s.charCodeAt(h++))&255];return~o}function V(s,T){for(var o=T^-1,h=s.length-15,x=0;x<h;)o=Y[s[x++]^o&255]^P[s[x++]^o>>8&255]^L[s[x++]^o>>16&255]^$[s[x++]^o>>>24]^S[s[x++]]^v[s[x++]]^u[s[x++]]^D[s[x++]]^b[s[x++]]^I[s[x++]]^y[s[x++]]^R[s[x++]]^F[s[x++]]^w[s[x++]]^f[s[x++]]^c[s[x++]];for(h+=15;x<h;)o=o>>>8^c[(o^s[x++])&255];return~o}function z(s,T){for(var o=T^-1,h=0,x=s.length,t=0,d=0;h<x;)t=s.charCodeAt(h++),t<128?o=o>>>8^c[(o^t)&255]:t<2048?(o=o>>>8^c[(o^(192|t>>6&31))&255],o=o>>>8^c[(o^(128|t&63))&255]):t>=55296&&t<57344?(t=(t&1023)+64,d=s.charCodeAt(h++)&1023,o=o>>>8^c[(o^(240|t>>8&7))&255],o=o>>>8^c[(o^(128|t>>2&63))&255],o=o>>>8^c[(o^(128|d>>6&15|(t&3)<<4))&255],o=o>>>8^c[(o^(128|d&63))&255]):(o=o>>>8^c[(o^(224|t>>12&15))&255],o=o>>>8^c[(o^(128|t>>6&63))&255],o=o>>>8^c[(o^(128|t&63))&255]);return~o}n.table=c,n.bstr=Z,n.buf=V,n.str=z})}(q)),q}var sn=tn();const on=pe(sn);var ee,de;function rn(){if(de)return ee;de=1;const e=2147483647,n=36,l=1,c=26,a=38,i=700,f=72,w=128,F="-",R=/^xn--/,y=/[^\0-\x7F]/,I=/[\x2E\u3002\uFF0E\uFF61]/g,b={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},D=n-l,u=Math.floor,v=String.fromCharCode;function S(t){throw new RangeError(b[t])}function $(t,d){const p=[];let g=t.length;for(;g--;)p[g]=d(t[g]);return p}function L(t,d){const p=t.split("@");let g="";p.length>1&&(g=p[0]+"@",t=p[1]),t=t.replace(I,".");const m=t.split("."),A=$(m,d).join(".");return g+A}function P(t){const d=[];let p=0;const g=t.length;for(;p<g;){const m=t.charCodeAt(p++);if(m>=55296&&m<=56319&&p<g){const A=t.charCodeAt(p++);(A&64512)==56320?d.push(((m&1023)<<10)+(A&1023)+65536):(d.push(m),p--)}else d.push(m)}return d}const Y=t=>String.fromCodePoint(...t),Z=function(t){return t>=48&&t<58?26+(t-48):t>=65&&t<91?t-65:t>=97&&t<123?t-97:n},V=function(t,d){return t+22+75*(t<26)-((d!=0)<<5)},z=function(t,d,p){let g=0;for(t=p?u(t/i):t>>1,t+=u(t/d);t>D*c>>1;g+=n)t=u(t/D);return u(g+(D+1)*t/(t+a))},s=function(t){const d=[],p=t.length;let g=0,m=w,A=f,M=t.lastIndexOf(F);M<0&&(M=0);for(let j=0;j<M;++j)t.charCodeAt(j)>=128&&S("not-basic"),d.push(t.charCodeAt(j));for(let j=M>0?M+1:0;j<p;){const k=g;for(let B=1,_=n;;_+=n){j>=p&&S("invalid-input");const O=Z(t.charCodeAt(j++));O>=n&&S("invalid-input"),O>u((e-g)/B)&&S("overflow"),g+=O*B;const W=_<=A?l:_>=A+c?c:_-A;if(O<W)break;const H=n-W;B>u(e/H)&&S("overflow"),B*=H}const U=d.length+1;A=z(g-k,U,k==0),u(g/U)>e-m&&S("overflow"),m+=u(g/U),g%=U,d.splice(g++,0,m)}return String.fromCodePoint(...d)},T=function(t){const d=[];t=P(t);const p=t.length;let g=w,m=0,A=f;for(const k of t)k<128&&d.push(v(k));const M=d.length;let j=M;for(M&&d.push(F);j<p;){let k=e;for(const B of t)B>=g&&B<k&&(k=B);const U=j+1;k-g>u((e-m)/U)&&S("overflow"),m+=(k-g)*U,g=k;for(const B of t)if(B<g&&++m>e&&S("overflow"),B===g){let _=m;for(let O=n;;O+=n){const W=O<=A?l:O>=A+c?c:O-A;if(_<W)break;const H=_-W,oe=n-W;d.push(v(V(W+H%oe,0))),_=u(H/oe)}d.push(v(V(_,0))),A=z(m,U,j===M),m=0,++j}++m,++g}return d.join("")};return ee={version:"2.3.1",ucs2:{decode:P,encode:Y},decode:s,encode:T,toASCII:function(t){return L(t,function(d){return y.test(d)?"xn--"+T(d):d})},toUnicode:function(t){return L(t,function(d){return R.test(d)?s(d.slice(4).toLowerCase()):d})}},ee}var cn=rn();const an=pe(cn);function ln(e,n,l,c){const a=C.Buffer.alloc(4);a.writeInt32BE(n.workChain);const i=C.Buffer.from(l,"utf8"),f=C.Buffer.alloc(4);f.writeUInt32BE(i.length);const w=C.Buffer.alloc(8);w.writeBigUInt64BE(BigInt(c));const F=e.type==="text"?"txt":"bin",R=e.type==="text"?e.text:e.bytes,y=e.type==="text"?"utf8":"base64",I=C.Buffer.from(F),b=C.Buffer.from(R,y),D=C.Buffer.alloc(4);D.writeUInt32BE(b.length);const u=C.Buffer.concat([C.Buffer.from([255,255]),C.Buffer.from("ton-connect/sign-data/"),a,n.hash,f,i,w,I,D,b]);return Te.createHash("sha256").update(u).digest()}function dn(e,n,l,c){const a=J.Cell.fromBase64(e.cell),i=on.buf(C.Buffer.from(e.schema,"utf8"))>>>0,f=un(l).toString("utf8"),w=J.beginCell().storeUint(1968607266,32).storeUint(i,32).storeUint(c,64).storeAddress(n).storeStringRefTail(f).storeRef(a).endCell();return C.Buffer.from(w.hash())}function un(e){if(!e)throw new Error("Domain must be non-empty");let n=e.toLowerCase();if(n.endsWith(".")&&(n=n.slice(0,-1)),n==="")return C.Buffer.from([0]);const l=n.split(".").map(i=>{if(i.length===0)throw new Error('Empty label ("..") not allowed');const f=an.toASCII(i);if(f.length>63||/[\x00-\x20]/.test(f))throw new Error(`Invalid label "${i}"`);return f}),c=[];for(const i of l.reverse())c.push(...C.Buffer.from(i,"utf8"),0);const a=C.Buffer.from(c);if(a.length>126)throw new Error(`Encoded name is ${a.length} bytes; TEP-81 allows at most 126`);return a}function fn(e){const{payload:n,domain:l,address:c,timestamp:a}=e,i=J.Address.parse(c),f=n.type==="cell"?dn(n,i,l,a):ln(n,i,l,a);return new Uint8Array(f)}function hn(e){const{payload:n,domain:l,address:c,timestamp:a,signature:i}=e;return{signature:C.Buffer.from(i).toString("base64"),address:c,timestamp:a,domain:l,payload:n}}const xn=(e,n)=>{const l=ke(),c=Be(),a=te(),{t:i}=X();return ye(async()=>{const f=new URL(e).host;if(!f.includes("."))throw new me("Invalid domain");const w=await Ne(c),F=fn({payload:n,domain:f,address:l.activeTonWallet.rawAddress,timestamp:w}),y=await Me({sdk:a,accountId:l.id,t:i})(F);return hn({payload:n,domain:f,address:l.activeTonWallet.rawAddress,timestamp:w,signature:y})})},ue=E.div`
    background: ${e=>e.theme.backgroundContent};
    border-radius: ${e=>e.theme.displayType==="full-width"?e.theme.corner2xSmall:e.theme.cornerMedium};

    padding: 16px 16px;
    width: 100%;
    box-sizing: border-box;
`,ne=E.div`
    font-family: ${e=>e.theme.fontMono};
    word-wrap: break-word;
`,fe=E.div`
    padding-top: 12px;
    display: flex;
    justify-content: flex-end;
    gap: 8px;
`,he=E(se)`
    color: ${e=>e.theme.textSecondary};
`,gn=E.div`
    width: 100%;
    box-sizing: border-box;
    padding: 12px 16px;

    background-color: ${e=>e.theme.accentOrange};
    position: relative;
    border-radius: ${e=>e.theme.displayType==="full-width"?e.theme.corner2xSmall:e.theme.cornerMedium};

    user-select: none;
`,pn=E(_e)`
    display: block;
    color: ${e=>e.theme.textPrimaryAlternate};
`,mn=E(se)`
    display: block;
    color: ${e=>e.theme.textPrimaryAlternate};
`,K=e=>e!==""&&e!=null,yn=e=>{if(!K(e))return!1;try{return J.Cell.fromBase64(e),!0}catch{return!1}},wn=({params:e})=>{const{t:n}=X(),l=te();switch(e.type){case"text":return r.jsxs(r.Fragment,{children:[r.jsxs(ue,{children:[r.jsx(ne,{children:e.text}),r.jsx(fe,{children:r.jsx(Q,{size:"small",onClick:G(()=>l.copyToClipboard(e.text,n("copied"))),children:n("receiveModal_copy")})})]}),r.jsx(he,{children:n("signDataTextDisclaimer")})]});case"cell":return r.jsxs(r.Fragment,{children:[r.jsx(he,{children:n("signDataCellDisclaimer")}),r.jsxs(ue,{children:[r.jsx(ne,{children:e.schema}),r.jsx(ne,{children:e.cell}),r.jsx(fe,{children:r.jsx(Q,{size:"small",onClick:G(()=>l.copyToClipboard(e.cell)),children:n("receiveModal_copy")})})]})]});default:return r.jsx(r.Fragment,{children:r.jsxs(gn,{children:[r.jsx(pn,{children:n("signDataBinaryContent")}),r.jsx(mn,{children:n("signDataBinaryContentDisclaimer")})]})})}},bn=E.div`
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
    margin: 1rem 0px 2rem;
`,Tn=E(Oe)`
    text-align: center;
`,Cn=({origin:e,params:n,handleClose:l})=>{const{t:c}=X(),[a,i]=N.useState(!1),[f,w]=N.useState(null),{mutateAsync:F,isLoading:R}=xn(e,n),y=async()=>{try{const b=await F();i(!0),setTimeout(()=>l(b),300)}catch(b){i(!0),w(b)}};return N.useMemo(()=>{switch(n.type){case"text":return K(n.text);case"binary":return K(n.bytes);case"cell":return K(n.schema)&&yn(n.cell);default:return!1}},[n])?r.jsxs(re,{onSubmit:G(y),children:[r.jsx(wn,{params:n}),r.jsxs(r.Fragment,{children:[a&&!f&&r.jsxs(ie,{done:!0,children:[r.jsx(De,{}),r.jsx(ce,{children:c("ton_login_success")})]}),a&&f&&r.jsxs(ie,{children:[r.jsx(Re,{}),r.jsx(ce,{children:f instanceof me?f.message:c("error_occurred")})]}),!a&&r.jsx(Q,{size:"large",fullWidth:!0,primary:!0,loading:R,disabled:R,type:"submit",children:c("signData")})]})]}):r.jsxs(re,{onSubmit:G(()=>l()),children:[r.jsxs(bn,{children:[r.jsx(Ie,{}),r.jsx(Tn,{children:c("signDataError")})]}),r.jsx(Q,{size:"large",fullWidth:!0,primary:!0,type:"submit",children:c("cancel")})]})},vn=E(Ue)`
    overflow: hidden;
    margin: 0;
    user-select: none;
    flex: 1;
`,Sn=E(se)`
    color: ${e=>e.theme.textSecondary};
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
`,An=E(We)`
    align-items: flex-start;
`,jn=E.div`
    display: flex;
    gap: 8px;
`,En=({origin:e,onClose:n})=>{const l=Ae(),{t:c}=X(),a=N.useMemo(()=>{try{return new URL(e).host}catch{return"UKNW"}},[e]);return r.jsx(je,{children:r.jsx(Ee,{children:r.jsxs(An,{handleClose:n,children:[r.jsx(vn,{children:a}),r.jsxs(jn,{children:[r.jsx(Sn,{children:c("signData")}),l.length>1?r.jsx(Fe,{}):void 0]})]})})})},Fn=({origin:e,params:n,handleClose:l})=>{const c=Ce(),a=N.useCallback(f=>{l(f),c(new ve({dapp_url:e,payload_type:n.type}))},[l]),i=N.useCallback(()=>{if(!(!n||!e))return r.jsxs(r.Fragment,{children:[r.jsx(En,{origin:e,onClose:()=>a()}),r.jsx(Cn,{origin:e,params:n,handleClose:f=>n!=null?a(f):void 0})]})},[e,n,a]);return r.jsx(r.Fragment,{children:r.jsx(Se,{isOpen:n!=null,handleClose:()=>a(),title:void 0,hideButton:!0,children:i})})},In=({request:e,handleClose:n,waitInvalidation:l})=>{var a;Le((a=e==null?void 0:e.connection)==null?void 0:a.manifest.url);const c=$e();return r.jsxs(r.Fragment,{children:[r.jsx(He,{params:(e==null?void 0:e.kind)==="sendTransaction"?e.payload:null,handleClose:i=>{e&&(n(i?Pe(e.id,i.boc):Ve(e.id)),i&&c({dappUrl:e.connection.manifest.url,sender:i.senderChoice}))},waitInvalidation:l}),r.jsx(Fn,{origin:(e==null?void 0:e.connection.type)==="injected"?e==null?void 0:e.connection.webViewOrigin:e==null?void 0:e.connection.manifest.url,params:(e==null?void 0:e.kind)==="signData"?e.payload:null,handleClose:i=>{e&&n(i?{id:e.id,result:i}:{id:e.id,error:{code:ze.USER_REJECTS_ERROR,message:"Reject Request"}})}})]})},Dn=()=>ye(nn),xe="TK_WEB::TON_CONNECT",kn=()=>{const[e,n]=N.useState(void 0),l=te(),c=Ke(),{data:a}=Je("http"),{data:i}=Ge(),f=Qe({skipEmit:!0}),{mutate:w}=Dn(),{mutateAsync:F}=Xe();N.useEffect(()=>{const y=(u,v)=>{const S=a==null?void 0:a.find($=>$.connections.some(L=>L.clientSessionId===u));S?F(S.wallet.id).then(()=>setTimeout(()=>{n(v)},100)):setTimeout(()=>{n(v)},100)},I=u=>{switch(u.request.method){case"disconnect":return f(u.connection).then(()=>ae({...u}));case"sendTransaction":{n(void 0);const v={connection:u.connection,id:u.request.id,kind:"sendTransaction",payload:JSON.parse(u.request.params[0])};return y(u.connection.clientSessionId,v)}case"signData":{n(void 0);const v={connection:u.connection,id:u.request.id,kind:"signData",payload:JSON.parse(u.request.params[0])};return y(u.connection.clientSessionId,v)}default:return w(u)}},{notifications:b}=l;(async()=>{if(b&&a)try{if(await b.subscribed(c.rawAddress))for(const v of a.flatMap(S=>S.connections))await b.subscribeTonConnect(v.clientSessionId,new URL(v.manifest.url).host)}catch(u){u instanceof Error&&l.topMessage(u.message)}})();const D=Ye({storage:l.storage,handleMessage:I,connections:a==null?void 0:a.flatMap(u=>u.connections),lastEventId:i});return()=>{D()}},[l,a,i,f,n,w]);const R=N.useCallback(()=>{e&&(n(void 0),Ze(xe,JSON.stringify({event:"close-tx-confirmation",id:e.id})))},[e,n]);return N.useEffect(()=>{if(e)return qe(xe,y=>{const I=JSON.parse(y);I.id===e.id&&I.event==="close-tx-confirmation"&&n(void 0)})},[e]),N.useEffect(()=>en.subscribe(y=>{(Array.isArray(y)?y:[y]).forEach((b,D)=>{b.type==="http"&&ae({connection:b,request:{id:(Date.now()+D).toString()}})})}),[]),r.jsx(In,{request:e,handleClose:R})};export{kn as default};
